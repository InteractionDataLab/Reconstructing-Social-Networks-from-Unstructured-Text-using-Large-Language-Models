---
title: "Evaluate GPT Parameters"
output: html_notebook
---

GPT Curation Parameters

1. Temperature Extraction
2. Temperature Matching
3. Batch sizes in Matching

First, Load the necessary data files, libraries and functions

```{r}
#OG parameters
version = "two-step" #Prompt type - specific indicates prompts with explicit instructions and examples (one/two shot)
output_format = "lol" #Output in a list of list format
model = "gpt-3.5-turbo-16k"

temperature_curation = c("0-0", "0-1", "0-3", "0-5", "0-7", "0-9") #Temperature used in the first extraction step of the pipeline
temperature_matching = c("0-0", "0-1", "0-3", "0-5", "0-7", "0-9") #Temperature used in the second matching step of the pipeline
breaks = c("1","10","20","50") #How many names are grouped together into one GPT request in the matching step

```

```{r}

jackknife_se = function(estimates, actual)
{
  se = sqrt(sum((estimates-actual)**2)*((length(estimates)-1)/length(estimates)))
  return(se)
}

```



Evaluate Extraction Temperature

Fix the Matching temperature at 0.3
Extraction temperature has the following values - 0.0, 0.1, 0.3, 0.5, 0.7, 0.9

```{r}

df_stats = data.frame()

temp_matching = "0-3"
br = "10"

for (temp in temperature_curation)
{
  load(paste("../data/processed/gpt_curated/inter-team/comparison_manual_gpt_fuzzy_", version, "_", br, "_", model, "_", temp_matching, "_", temp,".RData", sep = ""))
  
  precision = sum(df_merged$in_gpt == TRUE & df_merged$in_manual == TRUE, na.rm = TRUE)/sum(df_merged$in_gpt == TRUE, na.rm = TRUE)
  recall = sum(df_merged$in_gpt == TRUE & df_merged$in_manual == TRUE, na.rm = TRUE)/sum(df_merged$in_manual == TRUE, na.rm = TRUE)
  
  df_stats = rbind(df_stats, data.frame(temperature_curation = temp, temperature_matching = temp_matching, breaks = br, measure = "precision", score = precision, se = jackknife_se(df_stats_jackknife$precision[df_stats_jackknife$type == "gpt"], precision)))
  
  df_stats = rbind(df_stats, data.frame(temperature_curation = temp, temperature_matching = temp_matching, breaks = br, measure = "recall", score = recall, se = jackknife_se(df_stats_jackknife$recall[df_stats_jackknife$type == "gpt"], recall)))
  
}

```

```{r}

plt = ggplot(df_stats) + 
    geom_bar(aes(fill = temperature_curation, y=score, x=measure), position="dodge", stat="identity") +
    scale_fill_manual(breaks =  c("0-0","0-1","0-3","0-5","0-7","0-9"), values = (RColorBrewer::brewer.pal(n = 6, name = "Blues"))) +
    geom_errorbar(aes(fill = temperature_curation, ymin = score-se, ymax = score+se, x = measure), width = 0.1, position = position_dodge(0.9)) +
    ggtitle("") +
    theme_bw(base_size = 25) + coord_cartesian(ylim = c(0.0, 1)) + 
    xlab("") + ylab("") + theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) + theme(legend.position="none")

ggsave(plt, filename = "../figures/vary_temp_curation.png", width = 5, height = 5)

```


Fix the curation temperature at 0.3
Matching temperature has the following values - 0.0, 0.1, 0.3, 0.5, 0.7, 0.9

```{r}

df_stats = data.frame()

temp_curation = "0-3"
br = "10"

for (temp in temperature_matching)
{
  load(paste("../data/processed/gpt_curated/inter-team/comparison_manual_gpt_fuzzy_", version, "_", br, "_", model, "_", temp, "_", temp_curation,".RData", sep = ""))
  
  precision = sum(df_merged$in_gpt == TRUE & df_merged$in_manual == TRUE, na.rm = TRUE)/sum(df_merged$in_gpt == TRUE, na.rm = TRUE)
  recall = sum(df_merged$in_gpt == TRUE & df_merged$in_manual == TRUE, na.rm = TRUE)/sum(df_merged$in_manual == TRUE, na.rm = TRUE)
  
  df_stats = rbind(df_stats, data.frame(temperature_curation = temp_curation, temperature_matching = temp, breaks = br, measure = "precision", score = precision, se = jackknife_se(df_stats_jackknife$precision[df_stats_jackknife$type == "gpt"], precision)))
  
  df_stats = rbind(df_stats, data.frame(temperature_curation = temp_curation, temperature_matching = temp, breaks = br, measure = "recall", score = recall, se = jackknife_se(df_stats_jackknife$recall[df_stats_jackknife$type == "gpt"], recall)))
  
}

```

```{r}

plt = ggplot(df_stats) + 
    geom_bar(aes(fill = temperature_matching, y=score, x=measure), position="dodge", stat="identity") +
    scale_fill_manual(breaks =  c("0-0","0-1","0-3","0-5","0-7","0-9"), values = (RColorBrewer::brewer.pal(n = 6, name = "Blues"))) +
    geom_errorbar(aes(fill = temperature_matching, ymin = score-se, ymax = score+se, x = measure), width = 0.1, position = position_dodge(0.9)) +
    ggtitle("") +
    theme_bw(base_size = 25) + coord_cartesian(ylim = c(0.0, 1)) + 
    xlab("") + ylab("") + theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) + theme(legend.position="none")

ggsave(plt, filename = "../figures/vary_temp_matching.png", width = 5, height = 5)

```

Fix the curation and matching temperature at 0.3
breaks

```{r}

df_stats = data.frame()

temp_curation = "0-3"
temp_matching = "0-3"

for (br in breaks)
{
  load(paste("../data/processed/gpt_curated/inter-team/comparison_manual_gpt_fuzzy_", version, "_", br, "_", model, "_", temp_matching, "_", temp_curation,".RData", sep = ""))
  
  precision = sum(df_merged$in_gpt == TRUE & df_merged$in_manual == TRUE, na.rm = TRUE)/sum(df_merged$in_gpt == TRUE, na.rm = TRUE)
  recall = sum(df_merged$in_gpt == TRUE & df_merged$in_manual == TRUE, na.rm = TRUE)/sum(df_merged$in_manual == TRUE, na.rm = TRUE)
  
  df_stats = rbind(df_stats, data.frame(temperature_curation = temp_curation, temperature_matching = temp_matching, breaks = br, measure = "precision", score = precision, se = jackknife_se(df_stats_jackknife$precision[df_stats_jackknife$type == "gpt"], precision)))
  
  df_stats = rbind(df_stats, data.frame(temperature_curation = temp_curation, temperature_matching = temp_matching, breaks = br, measure = "recall", score = recall, se = jackknife_se(df_stats_jackknife$recall[df_stats_jackknife$type == "gpt"], recall)))
  
}

```

```{r}

plt = ggplot(df_stats) + 
    geom_bar(aes(fill = breaks, y=score, x=measure), position="dodge", stat="identity") +
    scale_fill_manual(breaks =  c("1","10","20","50"), values = (RColorBrewer::brewer.pal(n = 4, name = "Oranges"))) +
    geom_errorbar(aes(fill = breaks, ymin = score-se, ymax = score+se, x = measure), width = 0.1, position = position_dodge(0.9)) +
    ggtitle("") +
    theme_bw(base_size = 25) + coord_cartesian(ylim = c(0.0, 1)) + 
    xlab("") + ylab("") + theme(panel.grid.major = element_blank(),
panel.grid.minor = element_blank()) + theme(legend.position="none")

ggsave(plt, filename = "../figures/vary_batch_size.png", width = 5, height = 5)

```

