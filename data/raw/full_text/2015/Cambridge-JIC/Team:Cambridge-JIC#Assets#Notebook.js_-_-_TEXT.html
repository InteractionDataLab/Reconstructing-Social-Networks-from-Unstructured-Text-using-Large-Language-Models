Team:Cambridge-JIC/Assets/Notebook.js
(function(){"use strict";function _emitEvent(element,eventName,data){var event;if(document.createEvent){event=document.createEvent("HTMLEvents");event.initEvent(eventName,true,true)}else{event=document.createEventObject();event.eventType=eventName}event.eventName=eventName;event.data=data||{};if(document.createEvent){element.dispatchEvent(event)}else{element.fireEvent("on"+event.eventType,event)}}function GitGraph(options){options=typeof options==="object"?options:{};this.elementId=typeof options.elementId==="string"?options.elementId:"gitGraph";this.author=typeof options.author==="string"?options.author:"";if(typeof options.template==="string"||typeof options.template==="object"){this.template=this.newTemplate(options.template)}else if(options.template instanceof Template){this.template=options.template}else{this.template=this.newTemplate("metro")}this.mode=options.mode||null;if(this.mode==="compact"){this.template.commit.message.display=false}this.marginX=this.template.commit.dot.size*2;this.marginY=this.template.commit.dot.size*2;this.offsetX=0;this.offsetY=0;switch(options.orientation){case"vertical-reverse":this.template.commit.spacingY*=-1;this.orientation="vertical-reverse";break;case"horizontal":this.template.commit.message.display=false;this.template.commit.spacingX=this.template.commit.spacingY;this.template.branch.spacingY=this.template.branch.spacingX;this.template.commit.spacingY=0;this.template.branch.spacingX=0;this.orientation="horizontal";break;case"horizontal-reverse":this.template.commit.message.display=false;this.template.commit.spacingX=-this.template.commit.spacingY;this.template.branch.spacingY=this.template.branch.spacingX;this.template.commit.spacingY=0;this.template.branch.spacingX=0;this.orientation="horizontal-reverse";break;default:this.orientation="vertical";break}this.canvas=options.canvas||document.getElementById(this.elementId);this.context=this.canvas.getContext("2d");this.tooltip=document.createElement("div");this.tooltip.className="gitgraph-tooltip";this.tooltip.style.position="fixed";this.tooltip.style.display="none";document.body.appendChild(this.tooltip);this.HEAD=null;this.branchs=[];this.commits=[];this.columnMax=0;this.commitOffsetX=0;this.commitOffsetY=0;var mouseMoveOptions={handleEvent:this.hover,gitgraph:this};/*this.canvas.addEventListener("mousemove",mouseMoveOptions,false);*/window.onresize=this.render.bind(this)}GitGraph.prototype.branch=function(options){if(typeof options==="string"){var name=options;options={};options.name=name}options=typeof options==="object"?options:{};options.parent=this;options.parentBranch=options.parentBranch||this.HEAD;var branch=new Branch(options);this.branchs.push(branch);return branch};GitGraph.prototype.orphanBranch=function(options){if(typeof options==="string"){var name=options;options={};options.name=name}options=typeof options==="object"?options:{};options.parent=this;var branch=new Branch(options);this.branchs.push(branch);return branch};GitGraph.prototype.commit=function(options){this.HEAD.commit(options);return this};GitGraph.prototype.newTemplate=function(options){if(typeof options==="string"){return(new Template).get(options)}return new Template(options)};GitGraph.prototype.render=function(){var backingStorePixelRatio;var scalingFactor;scalingFactor=1;if(window.devicePixelRatio){backingStorePixelRatio=this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1;scalingFactor*=window.devicePixelRatio/backingStorePixelRatio}var unscaledResolution={x:Math.abs(this.columnMax*this.template.branch.spacingX)+Math.abs(this.commitOffsetX)+this.marginX*2,y:Math.abs(this.columnMax*this.template.branch.spacingY)+Math.abs(this.commitOffsetY)+this.marginY*2};if(this.template.commit.message.display){unscaledResolution.x+=800}this.canvas.style.width=unscaledResolution.x+"px";this.canvas.style.height=unscaledResolution.y+"px";this.canvas.width=unscaledResolution.x*scalingFactor;this.canvas.height=unscaledResolution.y*scalingFactor;this.context.scale(scalingFactor,scalingFactor);this.context.clearRect(0,0,this.canvas.width,this.canvas.height);this.context.translate(this.marginX,this.marginY);if(this.template.commit.spacingY>0){this.context.translate(0,this.canvas.height-this.marginY*2);this.offsetY=this.canvas.height-this.marginY*2}if(this.template.commit.spacingX>0){this.context.translate(this.canvas.width-this.marginX*2,0);this.offsetX=this.canvas.width-this.marginX*2}for(var i=this.branchs.length-1,branch;!!(branch=this.branchs[i]);i--){branch.render()}for(var j=0,commit;!!(commit=this.commits[j]);j++){commit.render()}};GitGraph.prototype.hover=function(event){var self=this.gitgraph;var isOut=true;event.offsetX=event.offsetX?event.offsetX:event.layerX;event.offsetY=event.offsetY?event.offsetY:event.layerY;event.x=event.x?event.x:event.clientX;event.y=event.y?event.y:event.clientY;function showCommitTooltip(){self.tooltip.style.left=event.x+"px";self.tooltip.style.top=event.y+"px";self.tooltip.textContent=commit.sha1+" - "+commit.message;self.tooltip.style.display="block"}function emitMouseoverEvent(){var mouseoverEventOptions={author:commit.author,message:commit.message,date:commit.date,sha1:commit.sha1};_emitEvent(self.canvas,"commit:mouseover",mouseoverEventOptions)}for(var i=0,commit;!!(commit=this.gitgraph.commits[i]);i++){var distanceX=commit.x+self.offsetX+self.marginX-event.offsetX;var distanceY=commit.y+self.offsetY+self.marginY-event.offsetY;var distanceBetweenCommitCenterAndMouse=Math.sqrt(Math.pow(distanceX,2)+Math.pow(distanceY,2));var isOverCommit=distanceBetweenCommitCenterAndMouse<self.template.commit.dot.size;if(isOverCommit){if(!self.template.commit.message.display){showCommitTooltip()}if(!commit.isMouseover){emitMouseoverEvent()}isOut=false;commit.isMouseover=true}else{commit.isMouseover=false}}if(isOut){self.tooltip.style.display="none"}};function Branch(options){if(options.parent instanceof GitGraph===false){return}options=typeof options==="object"?options:{};this.parent=options.parent;this.parentBranch=options.parentBranch;this.name=typeof options.name==="string"?options.name:"no-name";this.context=this.parent.context;this.template=this.parent.template;this.lineWidth=options.lineWidth||this.template.branch.lineWidth;this.lineDash=options.lineDash||this.template.branch.lineDash;this.spacingX=this.template.branch.spacingX;this.spacingY=this.template.branch.spacingY;this.size=0;this.height=0;this.width=0;this.commits=[];this.path=[];this.column=0;this.calculColumn();this.offsetX=this.column*this.spacingX;this.offsetY=this.column*this.spacingY;this.color=options.color||this.template.branch.color||this.template.colors[this.column];this.checkout()}Branch.prototype.branch=function(options){if(typeof options==="string"){var name=options;options={};options.name=name}options=typeof options==="object"?options:{};options.parent=this.parent;options.parentBranch=options.parentBranch||this;var branch=new Branch(options);this.parent.branchs.push(branch);return branch};Branch.prototype.render=function(){this.context.beginPath();for(var i=0,point;!!(point=this.path[i]);i++){if(point.type==="start"){this.context.moveTo(point.x,point.y)}else{if(this.template.branch.mergeStyle==="bezier"){var path=this.path[i-1];this.context.bezierCurveTo(path.x-this.template.commit.spacingX/2,path.y-this.template.commit.spacingY/2,point.x+this.template.commit.spacingX/2,point.y+this.template.commit.spacingY/2,point.x,point.y)}else{this.context.lineTo(point.x,point.y)}}}this.context.lineWidth=this.lineWidth;this.context.strokeStyle=this.color;if(this.context.setLineDash!==undefined){this.context.setLineDash(this.lineDash)}this.context.stroke();this.context.closePath()};Branch.prototype.commit=function(options){if(typeof options==="string"){var message=options;options={message:message}}else if(typeof options!=="object"){options={}}options.arrowDisplay=this.template.arrow.active;options.branch=this;options.color=options.color||this.color||this.template.commit.color||this.template.colors[this.column];options.parent=this.parent;options.parentCommit=options.parentCommit||this.commits.slice(-1)[0];if(this.parent.mode==="compact"&&this.parent.commits.slice(-1)[0]&&this.parent.commits.slice(-1)[0].branch!==options.branch&&options.branch.commits.length&&options.type!=="mergeCommit"){this.parent.commitOffsetX-=this.template.commit.spacingX;this.parent.commitOffsetY-=this.template.commit.spacingY}options.messageColor=options.messageColor||options.color||this.template.commit.message.color||null;options.dotColor=options.dotColor||options.color||this.template.commit.dot.color||null;options.x=this.offsetX-this.parent.commitOffsetX;options.y=this.offsetY-this.parent.commitOffsetY;var isVertical=this.parent.orientation==="vertical";var isNotCompact=this.parent.mode!=="compact";if(typeof options.detailId==="string"&&isVertical&&isNotCompact){options.detail=document.getElementById(options.detailId)}else if(typeof options.detailId==="object"&&isVertical&&isNotCompact){options.detail=options.detailId;options.detailId=options.detailId.id}else{options.detail=null}var previousCommit=options.branch.commits.slice(-1)[0]||{};var commitPosition=options.x+options.y;var previousCommitPosition=previousCommit.x+previousCommit.y;var isCommitAtSamePlaceThanPreviousOne=commitPosition===previousCommitPosition;if(isCommitAtSamePlaceThanPreviousOne){this.parent.commitOffsetX+=this.template.commit.spacingX;this.parent.commitOffsetY+=this.template.commit.spacingY;options.x=this.offsetX-this.parent.commitOffsetX;options.y=this.offsetY-this.parent.commitOffsetY}if(options.parentCommit instanceof Commit===false&&this.parentBranch instanceof Branch){options.parentCommit=this.parentBranch.commits.slice(-1)[0]}var commit=new Commit(options);this.commits.push(commit);var point={x:commit.x,y:commit.y,type:"join"};var isFirstBranch=commit.parentCommit instanceof Commit;var isPathBeginning=this.path.length===0;if(isFirstBranch&&isPathBeginning){var parent={x:commit.parentCommit.branch.offsetX-this.parent.commitOffsetX+this.template.commit.spacingX,y:commit.parentCommit.branch.offsetY-this.parent.commitOffsetY+this.template.commit.spacingY,type:"start"};this.path.push(JSON.parse(JSON.stringify(parent)));parent.type="join";this.parentBranch.path.push(parent)}else if(isPathBeginning){point.type="start"}this.path.push(point);this.parent.commitOffsetX+=this.template.commit.spacingX;this.parent.commitOffsetY+=this.template.commit.spacingY;if(commit.detail!==null){commit.detail.style.display="block";this.parent.commitOffsetY-=commit.detail.clientHeight-40}this.parent.render();return this};Branch.prototype.checkout=function(){this.parent.HEAD=this};Branch.prototype.delete=function(){this.isfinish=true};Branch.prototype.merge=function(target,commitOptions){var targetBranch=target||this.parent.HEAD;if(targetBranch instanceof Branch===false||targetBranch===this){return}var defaultMessage="Merge branch `"+this.name+"` into `"+targetBranch.name+"`";if(typeof commitOptions!=="object"){var message=commitOptions;commitOptions={};commitOptions.message=typeof message==="string"?message:defaultMessage}else{commitOptions.message=commitOptions.message||defaultMessage}commitOptions.type="mergeCommit";commitOptions.parentCommit=this.commits.slice(-1)[0];targetBranch.commit(commitOptions);var endOfBranch={x:this.offsetX+this.template.commit.spacingX*2-this.parent.commitOffsetX,y:this.offsetY+this.template.commit.spacingY*2-this.parent.commitOffsetY,type:"join"};this.path.push(JSON.parse(JSON.stringify(endOfBranch)));var mergeCommit={x:targetBranch.commits.slice(-1)[0].x,y:targetBranch.commits.slice(-1)[0].y,type:"end"};this.path.push(mergeCommit);endOfBranch.type="start";this.path.push(endOfBranch);this.parent.render();this.parent.HEAD=targetBranch;return this};Branch.prototype.calculColumn=function(){var candidates=[];for(var i=0,branch;!!(branch=this.parent.branchs[i]);i++){if(!branch.isfinish){var col=branch.column;if(!(col in candidates)){candidates[col]=0}candidates[col]++}}this.column=0;for(;;this.column++){if(!(this.column in candidates)||candidates[this.column]==0){break}}this.parent.columnMax=this.column>this.parent.columnMax?this.column:this.parent.columnMax};function Commit(options){if(options.parent instanceof GitGraph===false){return}options=typeof options==="object"?options:{};this.parent=options.parent;this.template=this.parent.template;this.context=this.parent.context;this.branch=options.branch;this.author=options.author||this.parent.author;this.date=options.date||(new Date).toUTCString();this.detail=options.detail||null;this.sha1=options.sha1||Math.random(100).toString(16).substring(3,10);this.message=options.message||"";this.arrowDisplay=options.arrowDisplay;this.messageDisplay=booleanOptionOr(options.messageDisplay,this.template.commit.message.display);this.messageAuthorDisplay=booleanOptionOr(options.messageAuthorDisplay,this.template.commit.message.displayAuthor);this.messageHashDisplay=booleanOptionOr(options.messageHashDisplay,this.template.commit.message.displayHash);this.messageColor=options.messageColor||options.color;this.messageFont=options.messageFont||this.template.commit.message.font;this.dotColor=options.dotColor||options.color;this.dotSize=options.dotSize||this.template.commit.dot.size;this.dotStrokeWidth=options.dotStrokeWidth||this.template.commit.dot.strokeWidth;this.dotStrokeColor=options.dotStrokeColor||this.template.commit.dot.strokeColor||options.color;this.type=options.type||null;this.parentCommit=options.parentCommit;this.x=options.x;this.y=options.y;this.parent.commits.push(this)}Commit.prototype.render=function(){this.context.beginPath();this.context.arc(this.x,this.y,this.dotSize,0,2*Math.PI,false);this.context.fillStyle=this.dotColor;this.context.strokeStyle=this.dotStrokeColor;this.context.lineWidth=this.dotStrokeWidth;if(typeof this.dotStrokeWidth==="number"){this.context.stroke()}this.context.fill();this.context.closePath();if(this.arrowDisplay&&this.parentCommit instanceof Commit){this.arrow()}if(this.detail!==null){this.detail.style.left=this.parent.canvas.offsetLeft+(this.parent.columnMax+1)*this.template.branch.spacingX+30+"px";this.detail.style.top=this.parent.canvas.offsetTop+this.y+40+"px";this.detail.width=30}if(this.messageDisplay){var message=this.message;if(this.messageHashDisplay){message=this.sha1+" "+message}if(this.messageAuthorDisplay){message=message+(this.author?" - "+this.author:"")}this.context.font=this.messageFont;this.context.fillStyle=this.messageColor;this.context.fillText(message,(this.parent.columnMax+1)*this.template.branch.spacingX,this.y+3)}};Commit.prototype.arrow=function Arrow(){var size=this.template.arrow.size;var color=this.template.arrow.color||this.branch.color;var alpha=Math.atan2(this.parentCommit.y-this.y,this.parentCommit.x-this.x);if(this.type==="mergeCommit"||this===this.branch.commits[0]){alpha=Math.atan2(this.template.branch.spacingY*(this.parentCommit.branch.column-this.branch.column)+this.template.commit.spacingY,this.template.branch.spacingX*(this.parentCommit.branch.column-this.branch.column)+this.template.commit.spacingX);color=this.parentCommit.branch.color}var delta=Math.PI/7;var h=this.template.commit.dot.size+this.template.arrow.offset;var x1=h*Math.cos(alpha)+this.x;var y1=h*Math.sin(alpha)+this.y;var x2=(h+size)*Math.cos(alpha-delta)+this.x;var y2=(h+size)*Math.sin(alpha-delta)+this.y;var x3=(h+size/2)*Math.cos(alpha)+this.x;var y3=(h+size/2)*Math.sin(alpha)+this.y;var x4=(h+size)*Math.cos(alpha+delta)+this.x;var y4=(h+size)*Math.sin(alpha+delta)+this.y;this.context.beginPath();this.context.fillStyle=color;this.context.moveTo(x1,y1);this.context.lineTo(x2,y2);this.context.quadraticCurveTo(x3,y3,x4,y4);this.context.lineTo(x4,y4);this.context.fill()};function Template(options){options=typeof options==="object"?options:{};options.branch=options.branch||{};options.arrow=options.arrow||{};options.commit=options.commit||{};options.commit.dot=options.commit.dot||{};options.commit.message=options.commit.message||{};this.colors=options.colors||["#6963FF","#47E8D4","#6BDB52","#E84BA5","#FFA657"];this.branch={};this.branch.color=options.branch.color||null;this.branch.lineWidth=options.branch.lineWidth||2;this.branch.lineDash=options.branch.lineDash||[];this.branch.mergeStyle=options.branch.mergeStyle||"bezier";this.branch.spacingX=typeof options.branch.spacingX==="number"?options.branch.spacingX:20;this.branch.spacingY=options.branch.spacingY||0;this.arrow={};this.arrow.size=options.arrow.size||null;this.arrow.color=options.arrow.color||null;this.arrow.active=typeof this.arrow.size==="number";this.arrow.offset=options.arrow.offset||2;this.commit={};this.commit.spacingX=options.commit.spacingX||0;this.commit.spacingY=typeof options.commit.spacingY==="number"?options.commit.spacingY:25;this.commit.color=options.commit.color||null;this.commit.dot={};this.commit.dot.color=options.commit.dot.color||null;this.commit.dot.size=options.commit.dot.size||3;this.commit.dot.strokeWidth=options.commit.dot.strokeWidth||null;this.commit.dot.strokeColor=options.commit.dot.strokeColor||null;this.commit.message={};this.commit.message.display=booleanOptionOr(options.commit.message.display,true);this.commit.message.displayAuthor=booleanOptionOr(options.commit.message.displayAuthor,true);this.commit.message.displayHash=booleanOptionOr(options.commit.message.displayHash,true);this.commit.message.color=options.commit.message.color||null;this.commit.message.font=options.commit.message.font||"normal 12pt Calibri"}Template.prototype.get=function(name){var template={};switch(name){case"blackarrow":template={branch:{color:"#000000",lineWidth:4,spacingX:50,mergeStyle:"straight"},commit:{spacingY:-60,dot:{size:12,strokeColor:"#000000",strokeWidth:7},message:{color:"black"}},arrow:{size:16,offset:2.5}};break;case"metro":default:template={colors:["#979797","#008fb5","#f1c109"],branch:{lineWidth:10,spacingX:50},commit:{spacingY:-80,dot:{size:14},message:{font:"normal 14pt Arial"}}};break}return new Template(template)};function booleanOptionOr(booleanOption,defaultOption){return typeof booleanOption==="boolean"?booleanOption:defaultOption}window.GitGraph=GitGraph;window.GitGraph.Branch=Branch;window.GitGraph.Commit=Commit;window.GitGraph.Template=Template})();
var notebookGraph=function(canvas){this._details=$("
");canvas.parent().append(this._details);this.newDetail=function(body,branch){if(body){var colour=this._branches[branch].colour;var detail=$('
').append(body).css("color",colour);this._details.append(detail);return detail.get(0)}else{return body}};this._gg=new GitGraph({canvas:canvas.get(0),template:new GitGraph.Template({branch:{lineWidth:10,spacingX:50},commit:{spacingY:-80,dotColor:"rgba(255,255,255,0.5)",dot:{size:14},message:{font:"normal 20px 'Open Sans', sans-serif",displayAuthor:false,displayHash:false}}}),author:"Cambridge-JIC"});this._cc={dotColor:"rgba(255,255,255,0.25)",dotSize:8,dotStrokeWidth:12};this._branches={};this.branch=function(root,name,colour){this._branches[name]={name:name,colour:colour,root:root,object:false}};this._bcount=0;this.getBranch=function(name){if(!name){return this._gg.HEAD}var branch=this._branches[name];if(branch.object){return branch.object}else{return branch.object=this._gg.branch({name:branch.name+this._bcount++,color:branch.colour,parentBranch:this.getBranch(branch.root)})}};this.adopt=function(root,child){if(this._branches[child].object){this.getBranch(child).delete()}this.branch(root,child,this._branches[child].colour)};this.commit=function(branch,subject,body){this.getBranch(branch).commit($.extend({message:subject,detailId:this.newDetail(body,branch)},this._cc))};this.merge=function(branch,into,subject,body){this.getBranch(branch).merge(this.getBranch(into),$.extend({message:subject,detailId:this.newDetail(body,into)},this._cc));this.adopt(into,branch)};return this}; var notebookGraphMob=function(canvas){this._branches={};this.canvas=$("
");canvas.replaceWith(this.canvas);this.newDetail=function(body,branch){if(body){var colour=this._branches[branch].colour;var detail=$('
').append(body).css("color",colour);return detail}else{return body}};this.branch=function(root,name,colour){this._branches[name]={name:name,colour:colour,root:root}};this.adopt=function(root,child){};this.commit=function(branch,subject,body){detail=$("
").css("color",this._branches[branch].colour);detail.append($("
").text(subject));detail.append($("
").html(body));console.log(detail.html());this.canvas.append(detail).append($('
'));};this.merge=function(branch,into,subject,body){this.commit(into,subject,body)};return this};
