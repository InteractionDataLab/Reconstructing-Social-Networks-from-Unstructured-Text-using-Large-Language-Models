"
Page
Discussion
View source
History
teams
Log in
 
Team:EPF-Lausanne/Modeling/bioreactor.js
From 2012.igem.org
$(function() {
$("#runButton").click(function() {    var defaultValue, defaults, error, key, value, values;    $("#formError").hide();    defaults = {      radius: 0.13,      power: 30,      reflective: false,      reflectiveAmount: 0.9,      absorbance: 0.02,      directed: false,      lightAngle: 20,      rays: 200,      resolution: 100,      nLights: 16,      nRings: 2    };    values = {};    for (key in defaults) {      defaultValue = defaults[key];      if (key === "reflective" || key === "directed") {        values[key] = $("#" + key)[0].checked;      } else {        values[key] = $("#" + key).val();      }      if (values[key] === "") {        values[key] = defaultValue;        $("#" + key).val(defaultValue);      }      values[key] = 1 * values[key];    }    for (key in values) {      value = values[key];      if (isNaN(values[key])) {        $("#formError").show();        $('html, body').animate({          scrollTop: $("#formError").offset().top        }, 200);        return false;      }    }    $('html, body').animate({      scrollTop: $("#resultsHeader").offset().top    }, 200);    $("#runButtonWrapper").hide();    $("#cancelButtonWrapper").show();    error = false;    try {      if (!(Simulation.start(values, function() {        $("#cancelButtonWrapper").hide();        return $("#runButtonWrapper").show();      }))) {        error = true;      }    } catch (e) {      error = true;    }    if (error) {      $('html, body').animate({        scrollTop: $("#formError").offset().top      }, 200);    }    return false;  });  return $("#cancelButton").click(function() {    $("#cancelButtonWrapper").hide();    $("#runButtonWrapper").show();    Simulation.cancel();    return false;  });
}); var Simulation; var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; }; Simulation = {
worker: void 0,  callback: void 0,  canvas: void 0,  ctx: void 0,  imageData: void 0,  canvasSize: 0,  outputCanvas: void 0,  outputSize: 0,  multiplier: 0,  lastData: void 0,  lastDraw: 0,  start: function(values, callback) {    var cellWidth;    if (this.worker !== void 0) {      return true;    }    cellWidth = 2 * values.radius / values.resolution;    this.multiplier = 1 / cellWidth / cellWidth / 200;    this.callback = callback;    this.canvas = $("<canvas>").attr("width", values.resolution).attr("height", values.resolution);    this.ctx = this.canvas[0].getContext("2d");    this.imageData = this.ctx.getImageData(0, 0, values.resolution, values.resolution);    this.canvasSize = values.resolution;    this.outputCanvas = $("#output");    if (this.canvasSize >= 200) {      this.outputSize = this.canvasSize;      this.outputCanvas.attr("width", this.outputSize).attr("height", this.outputSize);    } else {      this.outputSize = 400;      this.outputCanvas.attr("width", this.outputSize).attr("height", this.outputSize);    }    this.worker = new Worker("/Team:EPF-Lausanne/Modeling/bioreactorWorker.js?action=raw&ctype=text/javascript");    this.worker.addEventListener('message', __bind(function(e) {      var data, lost, progress, _ref;      _ref = JSON.parse(e.data), progress = _ref.progress, lost = _ref.lost, data = _ref.data;      return this.draw(progress, lost, data);    }, this), false);    return this.worker.postMessage(JSON.stringify(values));  },  draw: function(progress, lost, data) {    var b, col, g, r, row, saturated, total, x, y, _ref, _ref2, _ref3;    this.lastData = data;    $("#progress").html(progress.toFixed(2));    $("#lostLight").html(lost.toFixed(2));    if (progress >= 100 || (new Date()).getTime() - this.lastDraw > 800) {      this.lastDraw = (new Date()).getTime();      total = 0;      saturated = 0;      if (data !== void 0) {        row = 0;        for (y = 0, _ref = this.canvasSize; 0 <= _ref ? y < _ref : y > _ref; 0 <= _ref ? y++ : y--) {          col = 0;          for (x = 0, _ref2 = this.canvasSize; 0 <= _ref2 ? x < _ref2 : x > _ref2; 0 <= _ref2 ? x++ : x--) {            if ((data[x][y] * this.multiplier) >= 1) {              saturated += 1;            }            _ref3 = this.getColor(data[x][y] * this.multiplier), r = _ref3.r, g = _ref3.g, b = _ref3.b;            this.imageData.data[row + col] = r;            this.imageData.data[row + col + 1] = g;            this.imageData.data[row + col + 2] = b;            this.imageData.data[row + col + 3] = 255;            total += data[x][y];            col += 4;          }          row += this.canvasSize * 4;        }        this.ctx.putImageData(this.imageData, 0, 0);        this.outputCanvas[0].getContext("2d").drawImage(this.canvas[0], 0, 0, this.outputSize, this.outputSize);        $("#saturation").html(Math.min(100, (saturated / (this.canvasSize * this.canvasSize * Math.PI/4 * 0.99) * 100)).toFixed(2)); //Multiply surface by 0.99 to compensate single-pixel "rim" that can't be covered      }    }    if (progress >= 100) {      return this.finished();    }  },  getColor: function(value) {    var jet;    jet = function(value, a, b) {      var val;      val = Math.min(1, value);      return Math.max(0, Math.min(11, Math.min(4 * val + a, -4 * val + b)));    };    return {      r: Math.floor(255 * jet(value, -1.5, 4.5)),      g: Math.floor(255 * jet(value, -0.5, 3.5)),      b: Math.floor(255 * jet(value, 0.5, 2.5))    };  },  cancel: function() {    if (this.worker !== void 0) {      return this.worker.postMessage("STOP");    }  },  finished: function() {    this.worker = void 0;    if (this.callback !== void 0) {      return this.callback();    }  }
};
Retrieved from " http://2012.igem.org/Team:EPF-Lausanne/Modeling/bioreactor.js "
Recent changes
What links here
Related changes
Special pages
My preferences
Printable version
Permanent link
Privacy policy
Disclaimers
