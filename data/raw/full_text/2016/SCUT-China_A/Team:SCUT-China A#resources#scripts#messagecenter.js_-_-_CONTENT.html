<HTML lang="en" dir="ltr" class="client-nojs">
<style type="text/css">
A:before { content:' '; } 
A:after { content:' '; } 
SPAN:before { content:' '; } 
SPAN:after { content:' '; } 
</style>
<BODY class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-Team_SCUT-China_A_resources_scripts_messagecenter_js skin-igem action-view"><DIV id="globalWrapper"><DIV id="content" class="mw-body" role="main"><DIV id="top_title"><H1 id="firstHeading" class="firstHeading"><SPAN dir="auto">Team:SCUT-China A/resources/scripts/messagecenter.js</SPAN></H1></DIV><DIV id="HQ_page"><DIV id="bodyContent"><DIV id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><P>if (typeof console == 'undefined') console = {
</P><PRE>   log: function () { }
</PRE><P>};
</P><P>// sniff chrome
var CHROME_5_LOCAL = false;
var CHROME = false;
var SAFARI = false;
var FIREFOX = false;
var WEBKIT = false;
var OS_MAC = false;
var IOS = false;
var MOBILE_DEVICE = false;
</P><P>var IE = false;
var IE_10_AND_BELOW = false;  //ie 10 and lower
var IE_11_AND_ABOVE = false; //ie 11 and above
var BROWSER_VERSION = 5000;
(function () {
</P><PRE>   if(!window.$axure) window.$axure = function() {};
   var useragent = window.navigator.userAgent;
</PRE><PRE>   var edgeRegex = /Edge\/([0-9]+)/g;
   var edgeMatch = edgeRegex.exec(useragent);
   $axure.browser = { isEdge: Boolean(edgeMatch) };
</PRE><PRE>   if(!$axure.browser.isEdge) {
       var chromeRegex = /Chrome\/([0-9]+).([0-9]+)/g;
       var chromeMatch = chromeRegex.exec(useragent);
       CHROME = Boolean(chromeMatch);
       CHROME_5_LOCAL = chromeMatch &amp;&amp;
           Number(chromeMatch[1]) &gt;= 5 &amp;&amp;
           location.href.indexOf('file://') &gt;= 0;
   }
</PRE><PRE>   var safariRegex = /Safari\/([0-9]+)/g;
   var safariMatch = safariRegex.exec(useragent);
   SAFARI = Boolean(safariMatch) &amp;&amp; !CHROME; //because chrome also inserts safari string into user agent
</PRE><PRE>   var webkitRegex = /WebKit\//g ;
   WEBKIT = Boolean(webkitRegex.exec(useragent));
</PRE><PRE>   FIREFOX = useragent.toLowerCase().indexOf('firefox') &gt; -1;
</PRE><PRE>   var macRegex = /Mac/g ;
   OS_MAC = Boolean(macRegex.exec(window.navigator.platform));
</PRE><PRE>   IOS = useragent.match(/iPhone/i) || useragent.match(/iPad/i) || useragent.match(/iPod/i);
</PRE><PRE>   MOBILE_DEVICE = navigator.userAgent.match(/Android/i)
       || navigator.userAgent.match(/webOS/i)
       || navigator.userAgent.match(/iPhone/i)
       || navigator.userAgent.match(/iPad/i)
       || navigator.userAgent.match(/iPod/i)
       || navigator.userAgent.match(/BlackBerry/i)
       || navigator.userAgent.match(/Tablet PC/i)
       || navigator.userAgent.match(/Windows Phone/i);
   
   if($.browser) {
       if($.browser.msie) IE_10_AND_BELOW = true;
       else IE_11_AND_ABOVE = useragent.toLowerCase().indexOf('trident') &gt; -1;
</PRE><PRE>       BROWSER_VERSION = $.browser.version;
   }
</PRE><PRE>   IE = IE_10_AND_BELOW || IE_11_AND_ABOVE;
</PRE><PRE>   //Used by sitemap and variables.js getLinkUrl functions so that they know
   //whether to embed global variables in URL as query string or hash string
   //_shouldSendVars persists the value for sitemap instead of re-checking every time
   var _shouldSendVars;
   var _shouldSendVarsToServer = function(url) {
       if(typeof _shouldSendVars != 'undefined') {
           return _shouldSendVars;
       }
</PRE><PRE>       if(SAFARI || (IE_10_AND_BELOW &amp;&amp; BROWSER_VERSION &lt; 10)) {
           var urlToCheck = typeof url != 'undefined' ? url : window.location.href;
           var serverRegex = /http:\/\/127\.0\.0\.1:[0-9]{5}/g;
           var serverMatch = serverRegex.exec(urlToCheck);
           var previewRegex = /[0-9]{2}\.[0-9]{2}\.[0-9]{2}/g;
           var previewMatch = previewRegex.exec(urlToCheck);
           if(Boolean(serverMatch) &amp;&amp; Boolean(previewMatch)) {
               _shouldSendVars = true;
               return _shouldSendVars;
           }
       }
</PRE><PRE>       _shouldSendVars = false;
       return _shouldSendVars;
   };
   $axure.shouldSendVarsToServer = _shouldSendVarsToServer;
</PRE><P>})();
</P><P>(function() {
</P><PRE>   var _topMessageCenter;
   var _messageCenter = {};
   var _listeners = [];
   var _stateListeners = [];
   var _state = {};
   var _eventObject = null;
</PRE><PRE>   var _queuedMessages = [];
   var _initialized = false;
</PRE><PRE>   // this is for the non Chrome 5 local scenarios. The &quot;top&quot; message center will dispatch to all the bottom ones
   var _childrenMessageCenters = [];
</PRE><PRE>   // create $axure if it hasn't been created
   if (!window.$axure) window.$axure = function() {};
   $axure.messageCenter = _messageCenter;
</PRE><PRE>  // isolate scope, and initialize _topMessageCenter.
   (function() {
       if (!CHROME_5_LOCAL) {
           var topAxureWindow = window;
           try {
               while(topAxureWindow.parent &amp;&amp; topAxureWindow.parent !== topAxureWindow
                   &amp;&amp; topAxureWindow.parent.$axure) topAxureWindow = topAxureWindow.parent;
           } catch(e) {}
           _topMessageCenter = topAxureWindow.$axure.messageCenter;
       }
   })();
</PRE><PRE>   $(window.document).ready(function() {
       if (CHROME_5_LOCAL) {
</PRE>
            $('body').append(&quot;&quot; +
                &quot;&quot;);
<P>		    _eventObject = window.document.createEvent('Event');
		    _eventObject.initEvent('axureMessageSenderEvent', true, true);            
</P><PRE>           $('#axureEventReceiverDiv').bind('axureMessageReceiverEvent', function () {
               var request = JSON.parse($(this).text());
               _handleRequest(request);
           });
       } else {
           if (_topMessageCenter != _messageCenter) {
               _topMessageCenter.addChildMessageCenter(_messageCenter);
               console.log('adding from ' + window.location.toString());
           }
       }
   });
</PRE><PRE>   var _handleRequest = function (request) {
       // route the request to all the listeners
       for(var i = 0; i &lt; _listeners.length; i++) _listeners[i](request.message, request.data);
</PRE><PRE>       // now handle the queued messages if we're initializing
       if (request.message == 'initialize') {
           _initialized = true;
           // send all the queued messages and return
           for (var i = 0; i &lt; _queuedMessages.length; i++) {
               var qRequest = _queuedMessages[i];
               _messageCenter.postMessage(qRequest.message, qRequest.data);
           }
           _queuedMessages = [];
       }
               
       // and then handle the set state messages, if necessary
       if (request.message == 'setState') {
           _state[request.data.key] = request.data.value;
           for (var i = 0; i &lt; _stateListeners.length; i++) {
               var keyListener = _stateListeners[i];
               // if thep passed a null or empty value, always post the message
               if (!keyListener.key || keyListener.key == request.data.key) {
                   keyListener.listener(request.data.key, request.data.value);
               }
           }
       }
</PRE><PRE>   };
</PRE><PRE>   // -----------------------------------------------------------------------------------------
   // This method allows for dispatching messages in the non-chromelocal scenario.
   // Each child calls this on _topMessageCenter
   // -----------------------------------------------------------------------------------------
   _messageCenter.addChildMessageCenter = function(messageCenter) {
       _childrenMessageCenters[_childrenMessageCenters.length] = messageCenter;
   };
</PRE><PRE>   // -----------------------------------------------------------------------------------------
   // This method allows for dispatching messages in the non-chromelocal scenario.
   // Each child calls this on _topMessageCenter
   // -----------------------------------------------------------------------------------------
   _messageCenter.dispatchMessage = function(message, data) {
       _handleRequest({
           message: message,
           data: data
       });
   };
</PRE><PRE>   // -----------------------------------------------------------------------------------------
   // -----------------------------------------------------------------------------------------
   _messageCenter.dispatchMessageRecursively = function(message, data) {
       console.log(&quot;dispatched to &quot; + window.location.toString());
</PRE><PRE>       // dispatch to the top center first
       _messageCenter.dispatchMessage(message, data);
</PRE><PRE>       $('iframe').each(function(index, frame) {
           //try,catch to handle permissions error in FF when loading pages from another domain
           try {
               if (frame.contentWindow.$axure &amp;&amp; frame.contentWindow.$axure.messageCenter) {
                   frame.contentWindow.$axure.messageCenter.dispatchMessageRecursively(message, data);
               }
           }catch(e) {}
       });
   };
</PRE><PRE>   _messageCenter.postMessage = function(message, data) {
       if(!CHROME_5_LOCAL) {
           _topMessageCenter.dispatchMessageRecursively(message, data);
       } else {
           var request = {
               message: message,
               data: data
           };
</PRE><PRE>           if(_initialized) {
               var senderDiv = window.document.getElementById('axureEventSenderDiv');
               var messageText = JSON.stringify(request);
               //                console.log('sending event: ' + messageText);
               senderDiv.innerText = messageText;
               senderDiv.dispatchEvent(_eventObject);
               //                console.log('event sent');
           } else {
               _queuedMessages[_queuedMessages.length] = request;
           }
       }
   };
</PRE><PRE>   _messageCenter.setState = function(key, value) {
       var data = {
           key: key,
           value: value
       };
       _messageCenter.postMessage('setState', data);
   };
</PRE><PRE>   _messageCenter.getState = function(key) {
       return _state[key];
   };
</PRE><PRE>   _messageCenter.addMessageListener = function(listener) {
       _listeners[_listeners.length] = listener;
   };
</PRE><PRE>   _messageCenter.addStateListener = function(key, listener) {
       _stateListeners[_stateListeners.length] = {
           key: key,
           listener: listener
       };
   };
</PRE><P>})();
</P></DIV></DIV></DIV></DIV></DIV></BODY></HTML>