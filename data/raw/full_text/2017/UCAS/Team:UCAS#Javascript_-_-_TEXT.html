Team:UCAS/Javascript
function Vec3(x,y,z){var _this=this;this.x=x||0;this.y=y||0;this.z=z||0}Vec3.prototype={constructor:Vec3,plus:function(v){return new Vec3(this.x+v.x,this.y+v.y,this.z+v.z)},minus:function(v){return new Vec3(this.x-v.x,this.y-v.y,this.z-v.z)},dot:function(v){return this.x*v.x+this.y*v.y+this.z*v.z},cross:function(v){return new Vec3(this.y*v.z-this.z*v.y,this.z*v.x-this.x*v.z,this.x*v.y-this.y*v.x)},getLength:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},multiply:function(times){return new Vec3(this.x*times,this.y*times,this.z*times)},unit:function(){var len=this.getLength();if(len==0){console.log("Error in Vec3.unit: length = 0")}return this.clone().multiply(1/len)},clone:function(){return new Vec3(this.x,this.y,this.z)},equalToVector:function(v){return(this.minus(v).getLength())<1e-10},toString:function(){return"vec("+this.x+","+this.y+","+this.z+")"}};const variableNum=6;function WaterGrid(config){this.numx=config.numx;this.numy=config.numy;this.rangeY=this.numy;this.minRY=config.minRangeY;this.maxDepth=config.maxDepth;this.minDepth=config.minDepth;this.g=config.gravity;this.interval=config.interval;this.water=new Float32Array((this.numx)*(this.numy)*variableNum);var id;for(var nx=0;nx<this.numx;nx++){for(var ny=0;ny<this.numy;ny++){id=this.getIndex(nx,ny,0);this.water[id]=config.meanDepth;this.water[id+1]=0;this.water[id+2]=0;this.water[id+3]=0;this.water[id+4]=0;this.water[id+5]=0}}var _this=this;var rad=5;this.randWave=function(){};this.click=function(cx,cy,radius,amplitude){if(cx==undefined||cy==undefined){return}var cx=Math.floor(cx);var cy=Math.floor(cy);var id;var mult=1/(radius*radius);var res="";amplitude=Math.max(Math.min(amplitude,config.maxAmplitude),config.minAmplitude);for(var nx=Math.max(Math.floor(cx-radius),0),xm=Math.min(cx+radius,_this.numx);nx<xm;nx++){for(var ny=Math.max(Math.floor(cy-radius),0),ym=Math.min(cy+radius,_this.numy);ny<ym;ny++){id=_this.getIndex(nx,ny,0);_this.water[id]+=amplitude*Math.max(1-((nx-cx)*(nx-cx)+(ny-cy)*(ny-cy))*mult,0);if(_this.water[id]<_this.minDepth){_this.water[id]=_this.minDepth}else{if(_this.water[id]<_this.maxDepth){_this.water[id]=_this.maxDepth}}}}};this.getZ=function(x,y){var nx=Math.floor(x),ny=Math.floor(y),xratio=x-nx,yratio=y-ny;return(_this.water[_this.getIndex(nx,ny,0)]*(1-xratio)+_this.water[_this.getIndex(nx,ny+1,0)]*xratio)*(1-yratio)+(_this.water[_this.getIndex(nx+1,ny,0)]*(1-xratio)+_this.water[_this.getIndex(nx+1,ny+1,0)]*xratio)*yratio-_this.water[0]}}WaterGrid.prototype={constructor:WaterGrid,updateRatio:function(ratio){this.rangeY=Math.max(Math.min(ratio*this.numx,this.numy),this.minRY)},getIndex:function(x,y,serial){return(x+this.numx*y)*variableNum+serial},split:function(u,c){var s=new Array(6);s[0]=Math.max(u,0);s[1]=u-s[0];s[2]=Math.max(u+c,0);s[3]=u+c-s[2];s[4]=Math.max(u-c,0);s[5]=u-c-s[4];var res={};res.pSm=2*s[0]+s[2]+s[4];res.pSq=2*s[0]*u+s[2]*(u+c)+s[4]*(u-c);res.nSm=2*s[1]+s[3]+s[5];res.nSq=2*s[1]*u+s[3]*(u+c)+s[5]*(u-c);return res},iterate:function(){for(var nx=0;nx<this.numx;nx++){for(var ny=0;ny<this.rangeY;ny++){var id=this.getIndex(nx,ny,0);var h=this.water[id];var u=this.water[id+1];var v=this.water[id+2];var c=Math.sqrt(this.g*h);var us=this.split(u,c);var vs=this.split(v,c);var ratio=h/4;this.water[id+3]+=(us.pSm-us.nSm+vs.pSm-vs.nSm)*ratio;this.water[id+4]+=(us.pSq-us.nSq+vs.pSm*u-vs.nSm*u)*ratio;this.water[id+5]+=(us.pSm*v-us.nSm*v+vs.pSq-vs.nSq)*ratio;if(nx<this.numx-1){var tempId=this.getIndex(nx+1,ny,0);this.water[tempId+3]-=us.pSm*ratio;this.water[tempId+4]-=us.pSq*ratio;this.water[tempId+5]-=us.pSm*v*ratio}if(nx>1){var tempId=this.getIndex(nx-1,ny,0);this.water[tempId+3]+=us.nSm*ratio;this.water[tempId+4]+=us.nSq*ratio;this.water[tempId+5]+=us.nSm*v*ratio}if(ny<this.rangeY-1){var tempId=this.getIndex(nx,ny+1,0);this.water[tempId+3]-=vs.pSm*ratio;this.water[tempId+4]-=vs.pSm*u*ratio;this.water[tempId+5]-=vs.pSq*ratio}if(ny>1){var tempId=this.getIndex(nx,ny-1,0);this.water[tempId+3]+=vs.nSm*ratio;this.water[tempId+4]+=vs.nSm*u*ratio;this.water[tempId+5]+=vs.nSq*ratio}}}for(var nx=1;nx<this.numx-1;nx++){for(var ny=1;ny<this.rangeY-1;ny++){var id=this.getIndex(nx,ny,0);var h=this.water[id]-(this.water[id+3]*this.interval);var hu=this.water[id]*this.water[id+1]-(this.water[id+4]*this.interval);var hv=this.water[id]*this.water[id+2]-(this.water[id+5]*this.interval);if(h>this.maxDepth){this.water[id]=this.maxDepth}else{if(h<this.minDepth){this.water[id]=this.minDepth}else{this.water[id]=h}}if(nx==1||nx==(this.numx-2)){this.water[id+1]=0}else{this.water[id+1]=hu/h}if(ny==1||ny==(this.rangeY-2)){this.water[id+2]=0}else{this.water[id+2]=hv/h}this.water[id+3]=0;this.water[id+4]=0;this.water[id+5]=0}}}};const eps=1/65536;function WaterMesh(config){var numx=config.numx;var numy=config.numy;var x,y;var nextA=0,nextG=0;var points=[];var xmax=numx-2,ymax=numy-2;for(var i=0;i<config.pointNumber;i++){points.push({x:Math.random()*xmax,y:Math.random()*ymax})}points.push({x:0,y:0},{x:0,y:ymax},{x:xmax,y:ymax},{x:xmax,y:0}); var res=this.Delaunay(points);this.xmax=xmax;this.ymax=ymax;this.points=res.points,this.triangles=res.triangles;this.triangleNum=this.triangles.length;this.pointsNum=this.points.length;this.xtotal=(1+config.marginRatioX);this.ytotal=(1+config.marginRatioY);this.cutWidth=config.cutWidth;this.attrArray=new Float32Array(this.triangleNum*3*5);this.seqArray=new Int32Array(this.triangleNum*3);var nextSeq=0;for(var i=0;i<this.triangleNum;i++){tri=this.triangles[i];for(var j=0;j<3;j++){this.seqArray[nextSeq++]=tri[j]}}}WaterMesh.prototype={constructor:WaterMesh,tempTriangle:function(ps,index1,index2,index3){var x1=ps[index1].x;var y1=ps[index1].y;var x2=ps[index2].x;var y2=ps[index2].y;var x3=ps[index3].x;var y3=ps[index3].y;var vert12=Math.abs(y1-y2);var vert23=Math.abs(y2-y3);var xc,yc;if(vert12<eps&&vert23<eps){return null}if(vert12<eps){xc=(x2+x1)/2;yc=-((x3-x2)/(y3-y2))*(xc-((x2+x3)/2))+(y2+y3)/2}else{if(vert23<eps){xc=(x3+x2)/2;yc=-((x2-x1)/(y2-y1))*(xc-((x1+x2)/2))+(y1+y2)/2}else{var m1=-((x2-x1)/(y2-y1));var m2=-((x3-x2)/(y3-y2));var mx1=(x1+x2)/2;var mx2=(x2+x3)/2;var my1=(y1+y2)/2;var my2=(y2+y3)/2;xc=(m1*mx1-m2*mx2+my2-my1)/(m1-m2);yc=(vert12>vert23)?m1*(xc-mx1)+my1:m2*(xc-mx2)+my2}}dx=x2-xc;dy=y2-yc;return{index1:index1,index2:index2,index3:index3,x:xc,y:yc,r:dx*dx+dy*dy}},updateAttr:function(heightWidthRatio,getZ,amplify,cutRatioX,cutRatioY){this.heightWidthRatio=heightWidthRatio;var xtotal=this.xtotal,ytotal=this.ytotal;var scaleX=2*this.xtotal/this.xmax,scaleY=2*this.ytotal/(this.xmax*heightWidthRatio);nextAttr=0;nextSeq=0;theSame=true;var p3=new Array(3),h3=new Array(3),meanHeight,colorRatio,p;if(cutRatioX!=undefined){var zeroX=cutRatioX-this.cutWidth;var oneX=cutRatioX+this.cutWidth;var slope=1/(oneX-zeroX);for(var i=0,len=this.points.length;i<len;i++){p=this.points[i];p.glX=p.x*scaleX-xtotal;p.glY=ytotal-p.y*scaleY;if(p.glX<zeroX){p.colorRatio=0}else{if(p.glX>oneX){p.colorRatio=1}else{p.colorRatio=slope*(p.glX-zeroX)}}}}else{if(cutRatioY!=undefined){var zeroY=cutRatioY-this.cutWidth;var oneY=cutRatioY+this.cutWidth;var slope=1/(oneY-zeroY);for(var i=0,len=this.points.length;i<len;i++){p=this.points[i];p.glX=p.x*scaleX-xtotal;p.glY=ytotal-p.y*scaleY;if(p.glY<zeroY){p.colorRatio=0}else{if(p.glY>oneY){p.colorRatio=1}else{p.colorRatio=slope*(p.glY-zeroY)}}}}else{for(var i=0,len=this.points.length;i<len;i++){p=this.points[i];p.glX=p.x*scaleX-xtotal;p.glY=ytotal-p.y*scaleY;p.colorRatio=1}}}for(var i=0;i<this.triangleNum;i++){tri=this.triangles[i];p3[0]=this.points[this.seqArray[nextSeq++]];p3[1]=this.points[this.seqArray[nextSeq++]];p3[2]=this.points[this.seqArray[nextSeq++]];h3[0]=getZ(p3[0].x,p3[0].y);h3[1]=getZ(p3[1].x,p3[1].y);h3[2]=getZ(p3[2].x,p3[2].y);meanHeight=(h3[0]+h3[1]+h3[2])/3;for(var j=0;j<3;j++){this.attrArray[nextAttr++]=p3[j].glX;this.attrArray[nextAttr++]=p3[j].glY;if(theSame){if(Math.abs(this.attrArray[nextAttr]-h3[j])>eps){theSame=false}}this.attrArray[nextAttr++]=h3[j];this.attrArray[nextAttr++]=meanHeight;this.attrArray[nextAttr++]=1}}},Delaunay:function(points){var n=points.length;if(n<3){return[]}var xmin=Number.POSITIVE_INFINITY,ymin=Number.POSITIVE_INFINITY,xmax=Number.NEGATIVE_INFINITY,ymax=Number.NEGATIVE_INFINITY;for(var i=0,len=points.length;i<len;i++){if(points[i].x<xmin){xmin=points[i].x}if(points[i].x>xmax){xmax=points[i].x}if(points[i].y<ymin){ymin=points[i].y}if(points[i].y>ymax){ymax=points[i].y}}var dx=xmax-xmin;var dy=ymax-ymin;var dmax=Math.max(dx,dy);var xmid=xmin+dx*0.5;var ymid=ymin+dy*0.5;points.sort(function(p1,p2){return p2.y-p1.y});points.push({x:xmid-20*dmax,y:ymid-dmax},{x:xmid,y:ymid+20*dmax},{x:xmid+20*dmax,y:ymid-dmax});var undetermined=[];var determined=[];var tri=this.tempTriangle(points,n,n+1,n+2);undetermined.push(tri);var dx,dy,newEdge;for(var i=0;i<n;i++){newEdge=[];for(var j=undetermined.length;j--;){dy=points[i].y-undetermined[j].y;if(dy<0&&dy*dy>undetermined[j].r){determined.push(undetermined[j]);undetermined.splice(j,1);continue}dx=points[i].x-undetermined[j].x;if(dx*dx+dy*dy-undetermined[j].r>eps){continue}newEdge.push(undetermined[j].index1,undetermined[j].index2,undetermined[j].index2,undetermined[j].index3,undetermined[j].index1,undetermined[j].index3);undetermined.splice(j,1)}var p,q,s,t;for(var j=newEdge.length;j>0;){p=newEdge[--j];q=newEdge[--j];for(var k=j;k>0;){s=newEdge[--k];t=newEdge[--k];if((p===s&&q===t)||(p===t&&q===s)){newEdge.splice(j,2);newEdge.splice(k,2);break}}}var tri;for(var j=newEdge.length;j>0;){p=newEdge[--j];q=newEdge[--j];tri=this.tempTriangle(points,p,q,i);if(tri!=undefined){undetermined.push(tri)}}}var triangles=[];var triSeq;for(var i=determined.length-1;i>=0;i--){triSeq=determined[i];if(triSeq.index1<n&&triSeq.index2<n&&triSeq.index3<n){triangles.push([triSeq.index1,triSeq.index2,triSeq.index3])}}for(var i=undetermined.length-1;i>=0;i--){triSeq=undetermined[i];if(triSeq.index1<n&&triSeq.index2<n&&triSeq.index3<n){triangles.push([triSeq.index1,triSeq.index2,triSeq.index3])}}points.splice(n,3);return{points:points,triangles:triangles} }};var grid,waterMesh;onmessage=function(event){var data=event.data;if(data==undefined){postMessage([])}else{if(data["init"]==true){var config={numx:data["numx"],numy:data["numy"],maxAmplitude:data["maxAmplitude"],minAmplitude:data["minAmplitude"],meanDepth:data["meanDepth"],minRangeY:data["minRangeY"],maxDepth:data["maxDepth"],minDepth:data["minDepth"],marginRatioX:data["marginRatioX"],marginRatioY:data["marginRatioY"],pointNumber:data["pointNumber"],gravity:data["gravity"],interval:data["interval"],cutWidth:data["cutWidth"]};grid=new WaterGrid(config);waterMesh=new WaterMesh(config);postMessage(waterMesh.attrArray)}else{var cycleNum=data["cycleNum"];var heightWidthRatio=data["heightWidthRatio"];var crx=data["clickRatioX"],cry=data["clickRatioY"];grid.updateRatio(heightWidthRatio);if(crx){if(cry){var cx=grid.numx*(1+(2*crx-1)/waterMesh.xtotal)/2;var cy=grid.numx*waterMesh.heightWidthRatio*(cry+(0.5-0.5/waterMesh.ytotal))/(waterMesh.xtotal*waterMesh.ytotal);grid.click(cx,cy,data["clickRadius"],data["clickAmplitude"])}}for(var i=0;i<cycleNum;i++){grid.iterate()}var theSame=waterMesh.updateAttr(heightWidthRatio,grid.getZ,data["waveAmplify"],data["cutRatioX"],data["cutRatioY"]);if(theSame){postMessage([])}else{postMessage(waterMesh.attrArray)}}}};
