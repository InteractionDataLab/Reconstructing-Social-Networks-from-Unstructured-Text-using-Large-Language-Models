<HTML lang="en" dir="ltr" class="client-nojs">
<style type="text/css">
A:before { content:' '; } 
A:after { content:' '; } 
SPAN:before { content:' '; } 
SPAN:after { content:' '; } 
</style>
<BODY class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-Team_Tianjin_Resources_JS_jquerytouchPDF skin-igem action-view"><DIV id="globalWrapper"><DIV id="content" class="mw-body" role="main"><DIV id="top_title"><H1 id="firstHeading" class="firstHeading"><SPAN dir="auto">Team:Tianjin/Resources/JS:jquerytouchPDF</SPAN></H1></DIV><DIV id="HQ_page"><DIV id="bodyContent"><DIV id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><P>/*
</P><UL><LI> @fileOverview TouchPDF - jQuery Plugin</LI><LI> @version 0.4</LI><LI> @author Loic Minghetti <A rel="nofollow" class="external free" href="http://www.loicminghetti.net">http://www.loicminghetti.net</A></LI><LI> @see <A rel="nofollow" class="external free" href="https://github.com/loicminghetti/TouchPDF-Jquery-Plugin">https://github.com/loicminghetti/TouchPDF-Jquery-Plugin</A></LI><LI> @see <A rel="nofollow" class="external free" href="http://plugins.jquery.com/project/touchPDF">http://plugins.jquery.com/project/touchPDF</A></LI><LI> Copyright (c) 2014 Loic Minghetti</LI><LI> Dual licensed under the MIT or GPL Version 2 licenses.</LI><LI>/</LI></UL><P>/**
</P><PRE>* See (<A rel="nofollow" class="external free" href="http://jquery.com/">http://jquery.com/</A>).
* @name $
* @class 
* See the jQuery Library  (<A rel="nofollow" class="external free" href="http://jquery.com/">http://jquery.com/</A>) for full details.  This just
* documents the function and classes that are added to jQuery by this plug-in.
*/
</PRE><P>/**
</P><PRE>* See (<A rel="nofollow" class="external free" href="http://jquery.com/">http://jquery.com/</A>)
* @name fn
* @class 
* See the jQuery Library  (<A rel="nofollow" class="external free" href="http://jquery.com/">http://jquery.com/</A>) for full details.  This just
* documents the function and classes that are added to jQuery by this plug-in.
* @memberOf $
*/
</PRE><P>(function($) {
</P><PRE>       &quot;use strict&quot;;
</PRE><PRE>       //Constants
       var EMPTY = &quot;empty&quot;,
       INIT = &quot;init&quot;,
       LOADING = &quot;loading&quot;,
       LOADED = &quot;loaded&quot;,
       ZOOMEDIN = &quot;zoomedin&quot;,
       DRAGGING = &quot;dragging&quot;,
       RENDERING = &quot;rendering&quot;,
</PRE><PRE>       PLUGIN_NS = 'TouchPDF',
</PRE><PRE>       TOOLBAR_HEIGHT = 30,
       BORDER_WIDTH = 1,
       TAB_SPACING = -2,
       TAB_WIDTH = 41,
       TAB_OFFSET_WIDTH = 10;
</PRE><PRE>       /**
</PRE><P>	* The default configuration, and available options to configure touchPDF with.
	* You can set the default values by updating any of the properties prior to instantiation.
	* @name $.fn.pdf.defaults
	* @namespace
	* @property {string} [source=&quot;&quot;] Path of PDF file to display
	* @property {string} [title=&quot;TouchPDF&quot;] Title of the PDF to be displayed in the toolbar
	* @property {array} [tabs=[]] Array of tabs to display on the side. See doc for syntax.
	* @property {string} [tabsColor=&quot;beige&quot; Default background color for all tabs. Available colors are &quot;green&quot;, &quot;yellow&quot;, &quot;orange&quot;, &quot;brown&quot;, &quot;blue&quot;, &quot;white&quot;, &quot;black&quot; and you can define your own colors with CSS.
	* @property {boolean} [disableZoom=false] Disable zooming of PDF document. By default, PDF can be zoomed using scroll, two fingers pinch, +/- keys, and toolbar buttons
	* @property {boolean} [disableSwipe=false] Disable swipe to next/prev page of PDF document. By default, PDF can be swiped using one finger
	* @property {boolean} [disableLinks=false] Disable all internal and external links on PDF document
	* @property {boolean} [disableKeys=false] Disable the arrow keys for next/previous page and +/- for zooming (if zooming is enabled)
	* @property {boolean} [redrawOnWindowResize=true] Force resize of PDF viewer on window resize
	* @property {float} [pdfScale=1] Defines the ratio between your PDF page size and the tabs size
	* @property {float} [quality=2] Set quality ratio for loaded PDF pages. Set at 2 for sharp display when user zooms up to 200%
	* @property {boolean} [showToolbar=true] Show a toolbar on top of the document with title, page number and buttons for next/prev pages and zooming
	* @property {function} [loaded=null] A handler triggered when PDF document is loaded (before display of first page)
	* @property {function} [changed=null] A handler triggered each time a new page is displayed
	* @property {string} [loadingHTML=&quot;Loading PDF&quot;] Text or HTML displayed on white page shown before document is loaded 
	* @property {function} [loadingHeight=841] Height in px of white page shown before document is loaded 
	* @property {function} [loadingWidth=595] Width in px of white page shown before document is loaded 
	*/
</P><PRE>       var defaults = {
               source: null,
               title: &quot;TouchPDF&quot;,
               tabs: [],
               tabsColor: &quot;beige&quot;,
               disableZoom: false,
               disableSwipe: false,
               disableLinks: false,
               disableKeys: false,
               pdfScale: 1,
               quality: 2,
               redrawOnWindowResize: true,
               showToolbar: true,
               loaded: null,
               changed: null,
               loadingHeight: 841,
               loadingWidth: 595,
               loadingHTML: &quot;Loading PDF&quot;
       };
</PRE><PRE>       /**
</PRE><P>	* Load a PDF file in a div
	* The TouchPDF plugin can be instantiated via this method, or methods within 
	* @see TouchPDF
	* @class
	* @param {Mixed} method If the current DOMNode is a TouchPDF object, and <CODE>method</CODE> is a TouchPDF method, then
	* the <CODE>method</CODE> is executed, and any following arguments are passed to the TouchPDF method.
	* If <CODE>method</CODE> is an object, then the TouchPDF class is instantiated on the current DOMNode, passing the 
	* configuration properties defined in the object. See TouchPDF
	*/
</P><PRE>       $.fn.pdf = function(method) {
               var $this = $(this),
               plugin = $this.data(PLUGIN_NS);
</PRE><PRE>               //Check if we are already instantiated and trying to execute a method	
               if (plugin &amp;&amp; typeof method === 'string') {
                       if (plugin[method]) {
                               return plugin[method].apply(this, Array.prototype.slice.call(arguments, 1));
                       } else {
                               $.error('Method ' + method + ' does not exist on jQuery.pdf');
                       }
               }
               //Else not instantiated and trying to pass init object (or nothing)
               else if (!plugin &amp;&amp; (typeof method === 'object' ||Â !method)) {
                       return init.apply(this, arguments);
               }
</PRE><PRE>               return $this;
       };
</PRE><PRE>       //Expose our defaults so a user could override the plugin defaults
       $.fn.pdf.defaults = defaults;
</PRE><PRE>       /**
</PRE><P>	* Initialise the plugin for each DOM element matched
	* This creates a new instance of the main TouchPDF class for each DOM element, and then
	* saves a reference to that instance in the elements data property.
	* @internal
	*/
</P><PRE>       function init(options) {
               //Prep and extend the options
               if (!options) {
                       options = {};
               }
               options = $.extend({},
               $.fn.pdf.defaults, options);
</PRE><PRE>               //For each element instantiate the plugin
               return this.each(function() {
                       var $this = $(this);
</PRE><PRE>                       //Check we havent already initialised the plugin
                       var plugin = $this.data(PLUGIN_NS);
                       if (!plugin) {
                               plugin = new TouchPDF(this, options);
                               $this.data(PLUGIN_NS, plugin);
                       }
               });
       }
</PRE><PRE>       /**
</PRE><P>	* Main TouchPDF Plugin Class.
	* Do not use this to construct your TouchPDF object, use the jQuery plugin method $.fn.pdf(); {@link $.fn.pdf}
	* @private
	* @name TouchPDF
	* @param {DOMNode} element The HTML DOM object to apply to plugin to
	* @param {Object} options The options to configure the plugin with.  @link {$.fn.pdf.defaults}
	* @see $.fn.pdf.defaults
	* @see $.fn.pdf
</P><PRE>   * @class
</PRE><P>	*/
</P><PRE>       function TouchPDF(element, options) {
</PRE><PRE>               // Current phase of pdf loading
               var state = EMPTY;
               // Number of pages
               var totalPages = 0;
               // Page to be displayed
               var pageNum = 0;
               // Page currently rendering
               var pageNumRendering = 0;
               // jQuery wrapped element for this instance
               var $element = $(element);
               // PDF canvas
               var canvas = null;
               // jQuery wrapped PDF annotation layer
               var $annotations = null;
               // PDF.JS object
               var pdfDoc = null;
</PRE><PRE>               var scale = 1;
</PRE><PRE>               var ctx = false;
</PRE><PRE>               var pagesRefMap = [];
</PRE><PRE>               var plugin = this;
</PRE><PRE>               var tabWidth = 0;
               var $drag = null,
               $viewer = null;
</PRE><PRE>               var linksDisabled = false;
</PRE><PRE>               initDom();
               load();
</PRE><PRE>               //
               //Public methods
               //
               /**
</PRE><P>		* Go to specific page of PDF file
		* @function
		* @name $.fn.pdf#goto
		* @return {DOMNode} The Dom element that was registered with TouchPDF 
		* @example $(&quot;#element&quot;).pdf(&quot;goto&quot;, 10);
		*/
</P><PRE>               this.goto = function(number) {
                       goto(number);
                       return $element;
               };
</PRE><PRE>               /**
</PRE><P>		* Go to previous page of PDF file, until first page
		* @function
		* @name $.fn.pdf#previous
		* @return {DOMNode} The Dom element that was registered with TouchPDF 
		* @example $(&quot;#element&quot;).pdf(&quot;previous&quot;);
		*/
</P><PRE>               this.previous = function() {
                       goto(pageNum - 1);
                       return $element;
               };
</PRE><PRE>               /**
</PRE><P>		* Go to next page of PDF file, until end of pdf
		* @function
		* @name $.fn.pdf#next
		* @return {DOMNode} The Dom element that was registered with TouchPDF 
		* @example $(&quot;#element&quot;).pdf(&quot;next&quot;);
		*/
</P><PRE>               this.next = function() {
                       goto(pageNum + 1);
                       return $element;
               };
</PRE><PRE>               /**
</PRE><P>		* Force redraw of pdf (height, width and zoom)
		* @function
		* @name $.fn.pdf#redraw
		* @return {DOMNode} The Dom element that was registered with TouchPDF 
		* @example $(&quot;#element&quot;).pdf(&quot;redraw&quot;);
		*/
</P><PRE>               this.redraw = function() {
                       return $element;
               };
</PRE><PRE>               /**
</PRE><P>		* Destroy the pdf container completely.
		* @function
		* @name $.fn.pdf#destroy
		* @example $(&quot;#element&quot;).pdf(&quot;destroy&quot;);
		*/
</P><PRE>               this.destroy = function() {
                       $element.empty().removeClass(&quot;touchPDF&quot;);
</PRE><PRE>               };
</PRE><PRE>               /**
</PRE><P>		* Get the current page number (may not be rendered yet)
		* @function
		* @name $.fn.pdf#getPageNumber
		* @return {int} Current page number, 0 if PDF is not loaded
		* @example $(&quot;#element&quot;).pdf(&quot;getPageNumber&quot;);
		*/
</P><PRE>               this.getPageNumber = function() {
                       return pageNum;
               };
</PRE><PRE>               /**
</PRE><P>		* Get the total number of pages of loaded PDF
		* @function
		* @name $.fn.pdf#getTotalPages
		* @return {int} The number of pages, 0 if PDF is not loaded
		* @example $(&quot;#element&quot;).pdf(&quot;getTotalPages&quot;);
		*/
</P><PRE>               this.getTotalPages = function() {
                       return totalPages;
               };
</PRE><PRE>               //
               // Private methods
               //
</PRE><PRE>               function goto(number) {
                       if (state == EMPTY || state == INIT) return;
                       if (number &lt; 1) number = 1;
                       if (number &gt; totalPages) number = totalPages;
                       if (number == 0) return;
                       pageNum = number;
                       renderPage();
</PRE><PRE>                       // update tabs
                       var z = 1;
                       $element.find(&quot;.pdf-tabs .tab&quot;).each(function(i, a) {
                               var $a = $(a);
                               var aPageNum = $a.data(&quot;page&quot;);
                               if (aPageNum &lt; number) {
                                       $a.removeClass(&quot;right&quot;);
                                       $a.css(&quot;z-index&quot;, 1000 + z++);
                               } else if (aPageNum == number) {
                                       $a.removeClass(&quot;right&quot;);
                                       $a.css(&quot;z-index&quot;, 1000 + z++);
                               } else {
                                       $a.addClass(&quot;right&quot;);
                                       $a.css(&quot;z-index&quot;, 1000 - z++);
                               }
                       });
               }
</PRE><PRE>               function initDom() {
                       if (stateÂ != EMPTY) return;
</PRE>
                        $element.addClass(&quot;touchPDF&quot;).html('<DIV class="pdf-outerdiv">' + '' + '' + '<DIV class="pdf-viewer">' + '<DIV class="pdf-loading">' + options.loadingHTML + '</DIV>' + '<DIV class="pdf-drag">' + '<DIV class="pdf-canvas">' + '&lt;canvas&gt;&lt;/canvas&gt;' + '' + '</DIV>' + '</DIV>' + '</DIV>' + '</DIV>');
<PRE>                       if (options.showToolbar) {
</PRE>
                                $element.find(&quot;.pdf-toolbar&quot;).html('<DIV class="pdf-title">' + options.title + '</DIV>' + '<DIV class="pdf-button">&lt;button class=&quot;pdf-prev&quot;&gt;&lt;&lt;/button&gt;</DIV>' + '' + '<DIV class="pdf-button">&lt;button class=&quot;pdf-next&quot;&gt;&gt;&lt;/button&gt;</DIV>' + (options.disableZoomÂ ? <I>: '<DIV class="pdf-button">&lt;button class=&quot;pdf-zoomin&quot;&gt;+&lt;/button&gt;</DIV>' + '<DIV class="pdf-button">&lt;button class=&quot;pdf-zoomout&quot;&gt;-&lt;/button&gt;</DIV>'));</I><PRE>                               $element.find(&quot;.pdf-toolbar &gt; .pdf-title&quot;).on(&quot;click&quot;,
                               function() {
                                       goto(1);
                               });
                               $element.find(&quot;.pdf-toolbar &gt; .pdf-button &gt; .pdf-prev&quot;).on(&quot;click&quot;,
                               function() {
                                       goto(pageNum - 1);
                               });
                               $element.find(&quot;.pdf-toolbar &gt; .pdf-button &gt; .pdf-next&quot;).on(&quot;click&quot;,
                               function() {
                                       goto(pageNum + 1);
                               });
                       }
</PRE><PRE>                       $drag = $element.find(&quot;.pdf-drag&quot;);
                       $viewer = $element.find(&quot;.pdf-viewer&quot;);
</PRE><PRE>                       if (!options.disableKeys) {
                               $(window).keydown(function(event) {
                                       if (event.keyCode == 37) goto(pageNum - 1);
                                       else if (event.keyCode == 39) goto(pageNum + 1);
                               });
                       }
</PRE><PRE>                       if (options.redrawOnWindowResize) {
                               var windowResizeTimeout = false;
                               $(window).resize(function() {
                                       clearTimeout(windowResizeTimeout);
                                       windowResizeTimeout = setTimeout(function() {
                                               redraw();
                                       },
                                       100);
                               });
                       }
</PRE><PRE>                       if (!options.disableZoom) {
</PRE><PRE>                               $drag.panzoom({
                                       contain: 'invert',
                                       minScale: 1,
                                       disablePan: true,
                                       increment: 0.25,
                                       maxScale: 2,
                                       onChange: function() {
                                               linksDisabled = true;
                                               $drag.panzoom(&quot;option&quot;, &quot;disablePan&quot;, false);
                                               state = ZOOMEDIN;
                                       },
                                       onEnd: function() {
                                               setTimeout(function() {
                                                       linksDisabled = false;
                                                       if ($drag.panzoom(&quot;getMatrix&quot;)[0] == 1) zoomReset();
                                               },
                                               1);
                                       }
</PRE><PRE>                               });
                               $drag.panzoom('enable');
</PRE><PRE>                               $drag.parent().on('mousewheel.focal',
                               function(e) {
                                       e.preventDefault();
                                       var delta = e.delta || e.originalEvent.wheelDelta;
                                       var direction = deltaÂ ? delta &lt; 0Â : e.originalEvent.deltaY &gt; 0;
                                       if (direction) zoomOut(e);
                                       else zoomIn(e);
                               });
</PRE><PRE>                               if (options.showToolbar) {
                                       $element.find(&quot;.pdf-toolbar &gt; .pdf-button &gt; .pdf-zoomin&quot;).on(&quot;click&quot;,
                                       function() {
                                               zoomIn();
                                       });
                                       $element.find(&quot;.pdf-toolbar &gt; .pdf-button &gt; .pdf-zoomout&quot;).on(&quot;click&quot;,
                                       function() {
                                               zoomOut();
                                       });
                               }
</PRE><PRE>                               if (!options.disableLinks) {
                                       // enable links while zoomed in
                                       var touchlink = null;
                                       $drag.on('touchstart', &quot;a&quot;,
                                       function(e) {
                                               touchlink = this;
                                               setTimeout(function() {
                                                       touchlink = null;
                                               },
                                               100);
                                       });
                                       $drag.on('touchend', &quot;a&quot;,
                                       function(e) {
                                               if (this == touchlink) {
                                                       e.stopImmediatePropagation();
                                                       this.click();
                                               }
                                       });
                               }
                       }
</PRE><PRE>                       if (!options.disableSwipe) {
                               $viewer.swipe({
                                       swipe: function(event, direction, distance, duration, fingerCount, fingerData) {
                                               if (stateÂ != LOADED) return;
                                               linksDisabled = true;
                                               setTimeout(function() {
                                                       linksDisabled = false;
                                               },
                                               1);
                                               if (direction == &quot;right&quot;) goto(pageNum - 1);
                                               else if (direction == &quot;left&quot;) goto(pageNum + 1);
                                       },
                                       threshold: 50,
                                       excludedElements: &quot;.noSwipe&quot;
                               });
                       }
</PRE><PRE>                       canvas = $element.find(&quot;canvas&quot;)[0];
                       ctx = canvas.getContext('2d');
</PRE><PRE>                       $annotations = $element.find(&quot;.pdf-annotations&quot;);
</PRE><PRE>                       state = INIT;
</PRE><PRE>                       redraw();
               }
</PRE><PRE>               function zoomIn(focal) {
                       if (options.disableZoom) return;
                       if (stateÂ != ZOOMEDIN &amp;&amp; stateÂ != LOADED) return;
                       state = ZOOMEDIN;
                       $drag.panzoom('zoom', false, {
                               increment: 0.25,
                               animate: true,
                               focal: focal
                       });
                       linksDisabled = false;
               }
</PRE><PRE>               function zoomOut(focal) {
                       if (options.disableZoom) return;
                       if (stateÂ != ZOOMEDIN) return;
                       $drag.panzoom('zoom', true, {
                               increment: 0.25,
                               animate: true,
                               focal: focal
                       });
                       linksDisabled = false;
</PRE><PRE>                       if ($drag.panzoom(&quot;getMatrix&quot;)[0] == 1) zoomReset();
               }
               function zoomReset() {
                       if (options.disableZoom) return;
                       $drag.panzoom('reset');
                       linksDisabled = false;
                       $drag.panzoom(&quot;option&quot;, &quot;disablePan&quot;, true);
                       state = LOADED;
               }
</PRE><PRE>               /**
</PRE><P>		 * Asynchronously downloads PDF.
		 */
</P><PRE>               function load() {
                       if (stateÂ != INIT) return;
                       state = LOADING;
</PRE><PRE>                       PDFJS.getDocument(options.source).then(function(pdfDoc_) {
                               pdfDoc = pdfDoc_;
                               totalPages = pdfDoc.numPages;
                               if (totalPages &lt; 1) return;
</PRE><PRE>                               state = LOADED;
                               if (options.loaded) options.loaded() goto(1);
                       });
</PRE><PRE>                       if (options.tabs &amp;&amp; $.isArray(options.tabs)) {
</PRE><PRE>                               var top = [];
                               var maxOffset = 0;
</PRE><PRE>                               $.each(options.tabs,
                               function(i, tab) {
                                       if (tab.offset &amp;&amp; tab.offset &gt; maxOffset) maxOffset = tab.offset;
                               });
</PRE><PRE>                               tabWidth = TAB_WIDTH + TAB_OFFSET_WIDTH * maxOffset;
</PRE><PRE>                               $.each(options.tabs,
                               function(i, tab) {
                                       var offset = tab.offset || 0;
                                       if (top[offset] === undefined) {
                                               top[offset] = 5 + TOOLBAR_HEIGHT;
                                       }
</PRE><PRE>                                       var $a = $(&quot;&lt;a&gt;&quot;).addClass(&quot;tab&quot;).data(&quot;page&quot;, tab.page).css(&quot;margin-left&quot;, offset * TAB_OFFSET_WIDTH + &quot;px&quot;).css(&quot;margin-right&quot;, (maxOffset - offset) * TAB_OFFSET_WIDTH + &quot;px&quot;).click(function() {
                                               if (tab.page == pageNumRendering) goto(tab.page - 1);
                                               else goto(tab.page)
                                       });
                                       var $span = $(&quot;<SPAN>&quot;).html(tab.title).appendTo($a);
</SPAN></PRE><PRE>                                       if (tab.bottomÂ !== undefined) {
                                               $a.css(&quot;bottom&quot;, tab.bottom);
                                       } else {
                                               if (tab.topÂ !== undefined) top[offset] = tab.top + TOOLBAR_HEIGHT;
                                               $a.css(&quot;top&quot;, top[offset]);
                                       }
</PRE><PRE>                                       if (tab.title.length &gt; 2) $a.addClass(&quot;large&quot;);
                                       if (!tab.color) tab.color = options.tabsColor;
                                       $a.addClass(tab.color);
                                       if (tab.height) {
                                               $a.css(&quot;height&quot;, tab.height);
                                               $span.css(&quot;width&quot;, tab.height);
                                       }
</PRE><PRE>                                       $element.find(&quot;.pdf-tabs&quot;).append($a);
</PRE><PRE>                                       if (tab.bottom === undefined) top[offset] += $a.height() + TAB_SPACING;
                               });
                       }
               }
</PRE><PRE>               /**
</PRE><P>		* Get page info from document, resize canvas accordingly, and render page.
		* @param num Page number.
		*/
</P><PRE>               function renderPage() {
                       if (stateÂ != LOADED &amp;&amp; stateÂ != ZOOMEDIN) return;
                       if (pageNum == pageNumRendering) return;
</PRE><PRE>                       zoomReset();
                       state = RENDERING;
                       pageNumRendering = pageNum;
                       updatePageCount();
</PRE><PRE>                       // Using promise to fetch the page
                       pdfDoc.getPage(pageNumRendering).then(function(page) {
                               var viewport = page.getViewport(options.pdfScale * options.quality);
                               canvas.height = viewport.height;
                               canvas.width = viewport.width;
                               $(&quot;.pdf-canvas&quot;).css(&quot;transform&quot;, &quot;scale(&quot; + (1 / options.quality) + &quot;)&quot;).css(&quot;transform-origin&quot;, &quot;top left&quot;);
</PRE><PRE>                            // Render PDF page into canvas context
                               var renderTask = page.render({
                                       canvasContext: ctx,
                                       viewport: viewport
                               });
</PRE><PRE>                               if (!options.disableLinks) {
                                       renderAnnotations(page, viewport);
                               }
</PRE><PRE>                               // Wait for rendering to finish
                               renderTask.promise.then(function() {
                                       state = LOADED;
                                       if (pageNumRenderingÂ != pageNum) {
                                               // New page rendering is pending
                                               renderPage();
                                       }
                               });
</PRE><PRE>                               redraw();
                               $element.find(&quot;.pdf-loading&quot;).hide();
                               $element.find(&quot;.pdf-tabs&quot;).css(&quot;visibility&quot;, &quot;visible&quot;);
                               $element.find(&quot;canvas&quot;).css(&quot;visibility&quot;, &quot;visible&quot;);
</PRE><PRE>                               if (options.changed) options.changed();
</PRE><PRE>                       });
               }
</PRE><PRE>               function redraw() {
</PRE><PRE>                       if (state == INIT) {
                               var pdfHeight = options.loadingHeight;
                               var pdfWidth = options.loadingWidth;
</PRE><PRE>                       } else {
                               var pdfHeight = canvas.height / options.quality;
                               var pdfWidth = canvas.width / options.quality;
                       }
                       var winHeight = $element.height();
                       var winWidth = $element.width();
</PRE><PRE>                       scale = Math.min(winHeight / (pdfHeight + TOOLBAR_HEIGHT + BORDER_WIDTH * 2), winWidth / (pdfWidth + tabWidth * 2 + BORDER_WIDTH * 2));
                       if (scale &gt; 1) scale = 1;
</PRE><PRE>                       $element.find(&quot;.pdf-outerdiv&quot;).css(&quot;transform&quot;, &quot;scale(&quot; + scale + &quot;)&quot;).css(&quot;width&quot;, pdfWidth + BORDER_WIDTH * 2).css(&quot;height&quot;, pdfHeight + TOOLBAR_HEIGHT + BORDER_WIDTH * 2).css(&quot;padding&quot;, &quot;0 &quot; + tabWidth + &quot;px&quot;).css(&quot;left&quot;, (winWidth - scale * (pdfWidth + tabWidth * 2 + BORDER_WIDTH * 2)) / 2);
</PRE><PRE>                       $element.find(&quot;.pdf-toolbar&quot;).css(&quot;width&quot;, pdfWidth).css(&quot;height&quot;, TOOLBAR_HEIGHT).css(&quot;left&quot;, tabWidth + BORDER_WIDTH);
</PRE><PRE>                       $viewer.css(&quot;width&quot;, pdfWidth).css(&quot;height&quot;, pdfHeight).css(&quot;left&quot;, tabWidth).css(&quot;top&quot;, TOOLBAR_HEIGHT).css(&quot;border-width&quot;, BORDER_WIDTH);
</PRE><PRE>                       $drag.css(&quot;width&quot;, pdfWidth).css(&quot;height&quot;, pdfHeight);
</PRE><PRE>                       if (!options.disableZoom) {
                               $drag.panzoom('resetDimensions');
                       }
</PRE><PRE>                       if (!options.disableSwipe) {
                               $viewer.swipe(&quot;option&quot;, &quot;threshold&quot;, 75 * scale);
                       }
</PRE><PRE>               }
</PRE><PRE>               function updatePageCount() {
                       if (state == EMPTY || state == INIT) return;
                       $element.find(&quot;.pdf-page-count&quot;).html(pageNum + &quot; / &quot; + totalPages);
               }
</PRE><PRE>               function getPageIndex(destRef) {
                       var defer = $.Deferred();
</PRE><PRE>                       if (pagesRefMap[destRef.num + ' ' + destRef.gen + ' R']) {
                               defer.resolve(pagesRefMap[destRef.num + ' ' + destRef.gen + ' R']);
</PRE><PRE>                       } else {
                               pdfDoc.getPageIndex(destRef).then(function(pageIndex) {
                                       pagesRefMap[destRef.num + ' ' + destRef.gen + ' R'] = pageIndex + 1;
                                       defer.resolve(pageIndex + 1);
                               });
                       }
                       return defer.promise();
               }
</PRE><PRE>               function renderAnnotations(page, viewport) {
                       if (stateÂ != RENDERING) return;
</PRE><PRE>                       $annotations.empty();
</PRE><PRE>                       page.getAnnotations().then(function(annotationsData) {
</PRE><PRE>                               viewport = viewport.clone({
                                       dontFlip: true
                               });
</PRE><PRE>                               $.each(annotationsData,
                               function(i, data) {
                                       if (!data ||Â !data.hasHtml || data.subtypeÂ !== 'Link' || (!data.dest &amp;&amp;Â !data.url)) return;
</PRE><PRE>                                       var $el = $(PDFJS.AnnotationUtils.getHtmlElement(data, page.commonObjs));
                                       var rect = data.rect;
                                       var view = page.view;
                                       rect = PDFJS.Util.normalizeRect([rect[0], view[3] - rect[1] + view[1], rect[2], view[3] - rect[3] + view[1]]);
                                       $el.css(&quot;left&quot;, rect[0] + 'px').css(&quot;top&quot;, rect[1] + 'px').css(&quot;position&quot;, 'absolute');
</PRE><PRE>                                       var transform = viewport.transform;
                                       var transformStr = 'matrix(' + transform.join(',') + ')';
                                       $el.css('transform', transformStr);
                                       var transformOriginStr = -rect[0] + 'px ' + -rect[1] + 'px';
                                       $el.css('transformOrigin', transformOriginStr);
</PRE><PRE>                                       var link = $el.find(&quot;a&quot;).on('mousedown',
                                       function(e) {
                                               e.preventDefault();
                                       });
</PRE><PRE>                                       if (data.url) {
</PRE><PRE>                                               link.addClass(&quot;externalLink&quot;).attr(&quot;href&quot;, data.url).attr(&quot;target&quot;, &quot;_blank&quot;);
</PRE><PRE>                                       } else if (data.dest) {
</PRE><PRE>                                               link.addClass(&quot;internalLink&quot;).data(&quot;dest&quot;, data.dest).on('click',
                                               function(e) {
                                                       if (stateÂ != LOADED &amp;&amp; stateÂ != ZOOMEDIN) return false;
                                                       if (linksDisabled) return false;
                                                       var dest = $(this).data(&quot;dest&quot;);
</PRE><PRE>                                                       if (dest instanceof Array) {
                                                               getPageIndex(dest[0]).then(function(num) {
                                                                       if (stateÂ != LOADED &amp;&amp; stateÂ != ZOOMEDIN) return;
                                                                       goto(num);
                                                               });
                                                       } else {
                                                               pdfDoc.getDestination($(this).data(&quot;dest&quot;)).then(function(destRefs) {
                                                                       if (! (destRefs instanceof Array)) return; // invalid destination
                                                                       getPageIndex(destRefs[0]).then(function(num) {
                                                                               if (stateÂ != LOADED &amp;&amp; stateÂ != ZOOMEDIN) return;
                                                                               if (linksDisabled) return;
                                                                               goto(num);
                                                                       });
                                                               });
                                                       }
                                                       return false;
                                               });
                                       }
</PRE><PRE>                                       $annotations.append($el);
                               });
</PRE><PRE>                       });
</PRE><PRE>               }
</PRE><PRE>       }
</PRE><P>})(jQuery);</P></DIV></DIV></DIV></DIV></DIV></BODY></HTML>