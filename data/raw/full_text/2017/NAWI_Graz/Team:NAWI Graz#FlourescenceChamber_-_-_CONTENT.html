<HTML lang="en" dir="ltr" class="client-nojs">
<style type="text/css">
A:before { content:' '; } 
A:after { content:' '; } 
SPAN:before { content:' '; } 
SPAN:after { content:' '; } 
</style>
<BODY class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-Team_NAWI_Graz_FlourescenceChamber skin-igem action-view"><DIV id="globalWrapper"><DIV id="content" class="mw-body" role="main"><DIV id="top_title"><H1 id="firstHeading" class="firstHeading"><SPAN dir="auto">Team:NAWI Graz/FlourescenceChamber</SPAN></H1></DIV><DIV id="HQ_page"><DIV id="bodyContent"><DIV id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><DIV class="menu-navbar"><NAV class="navbar navbar-expand-lg navbar-light bg-light"><DIV class="collapse navbar-collapse" id="navbarNavDropdown"><UL class="navbar-nav ml-auto"><LI class="nav-item dropdown"><DIV class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink"><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/Description">Description</A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/Design">Design</A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/Demonstrate">Demonstrate</A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/Model">Model</A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/Application">Application</A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/Results">Results</A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/InterLab">InterLab Measurement Study</A></DIV></LI><LI class="nav-item dropdown"><A class="nav-link dropdown-toggle" role="button" href="https://2017.igem.org/Team:NAWI_Graz/Hardware" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Components
                </A><DIV class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink"><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/Hardware"><SPAN class="top-menu">Parts</SPAN></A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/Arena">Arena</A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/Bioreactor">Bioreactor</A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/Robot">Robot</A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/ControlSystem">Control System</A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/TemperatureModule">Temperature Interaction Module</A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/TemperaturePlasmid">Temperature Plasmid</A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/phInteractionModule">pH Interaction Module</A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/pHPlasmid">pH Plasmid</A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/FlourescenceChamber">Flourescence Measurement Chamber</A></DIV></LI><LI class="nav-item dropdown"><A class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Team
                </A><DIV class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink"><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/Team">NAWI_Graz 2017</A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/Collaborations">Collaborations</A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/Attributions">Attributions</A></DIV></LI><LI class="nav-item dropdown"><A class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Lab Book
                </A><DIV class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink"><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/Notebook">Notebook</A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/WP">Working Protocols</A></DIV></LI><LI class="nav-item dropdown"><A class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Human Practices
                </A><DIV class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink"><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/HP/Silver">Public Engagement</A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/HP/Gold">Integrated Human Practices</A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/Discussions">Discussions</A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/Education">Education</A><A class="dropdown-item" href="https://2017.igem.org/Team:NAWI_Graz/Interviews">Interviews</A></DIV></LI><LI class="nav-item"><A class="nav-link" href="https://2017.igem.org/Team:NAWI_Graz/Safety">Safety</A></LI></UL><UL class="navbar-nav ml-auto"><LI class="nav-item"><A class="nav-link" href="https://igem.org/2017_Judging_Form?team=NAWI_Graz">Judging Form</A></LI></UL></DIV></NAV></DIV><BUTTON onclick="topFunction()" id="topBtn" class="btn-info" title="Go to top">Go to Top</BUTTON><DIV class="jumbotron"><DIV class="section section-heading container"><H1>FLOURESCENCE MEASUREMENT CHAMBER</H1></DIV><DIV class="section container"><DIV class="section-text container"><P>A 3D printed case housing a cuvette (with in- and outflow tubes), LEDs to excite the fluorescent proteins, optical filters and two camera-modules. We look into the raw RGB data in a region of interest to detect bacterial fluorescence. The information from both cameras is aggregated into a single output: the next command to the robot.</P></DIV></DIV></DIV><DIV class="section container"><DIV class="section-sub-text"><B>Fig. 1:</B> Overview of all parts constituting the fluorescence measurement chamber. See detailed description of all parts below.
    </DIV></DIV><DIV class="section container"><H2 class="section-sub">Casing</H2><DIV class="section-text container"><P>The chamber is a two-part 3D-printed enclosure (see Fig. 2) with two facing walls housing sockets for LEDs that are all directed towards the center of the chamber. The outer two LED sockets of each row of three are oriented diagonally, their convergence in the interior can be seen in the bottom part of Fig. 2. The other two facing walls each contain one socket for a camera. If the two parts are plugged together, a rectangular tunnel passes through the chamber, leaving just enough space for the UV-cuvette and the placement of optical filters on each side.</P></DIV></DIV><DIV class="section container"><DIV class="section-sub-text"><B>Fig. 2:</B> The two parts of the casing are shown from two different perspectives.
    </DIV></DIV><DIV class="section container"><H2 class="section-sub">LEDs and Optical Filters</H2><DIV class="section-text container"><P>Because of the expressed fluorescent proteins’ spectral characteristics we chose unmounted 5 mm LEDs emitting light of two different wavelengths, 490 and 600 nm respectively, three of each. Between camera and cuvette, we placed optical filters to exclude the exciting frequencies from influencing the quality of the fluorescence detection. The filters we used were <B>101 YELLOW</B> (LEE Filters, see Fig. 3) for the protein excited at 490 nm (mNeonGreen), and <B>795 MAGICAL MAGENTA</B> (LEE Filters, see Fig. 4) for the one with peak excition at 604 nm (mCardinal).</P></DIV></DIV><DIV class="section container"><DIV class="section-sub-text"><B>Fig. 3:</B> Characteristics of the filter <B>101 YELLOW</B> (LEE Filters).
    </DIV></DIV><DIV class="section container"><DIV class="section-sub-text"><B>Fig. 4:</B> Characteristics of the filter <B>795 MAGICAL MAGENTA</B> (LEE Filters).
    </DIV></DIV><DIV class="section container"><H2 class="section-sub">UV-Cuvette Compartment</H2><DIV class="section-text container"><P>A UV-permissible quartz cuvette modified such as to connect to tubes on both ends to allow for the controlled transition and residence of bacterial suspension. Even though all wavelengths we used in all our experiments were in the visible spectrum, we chose this type of cuvette to enable the system to be used in a more general context.</P></DIV></DIV><DIV class="section container"><H2 class="section-sub">Cameras</H2><DIV class="section-text container"><P>Two cameras (<A href="https://www.raspberrypi.org/products/camera-module-v2/">Raspberry Pi Camera Module v2</A>) are attached to their appropriate slots in the casing of the fluorescence measurement chamber, each one dedicated to measuring the fluorescence of a specific protein. The <I>master camera</I> is connected directly to the <A href="https://2017.igem.org/Team:NAWI_Graz/ControlSystem">control system RPi</A>, while the second <I>slave camera</I> is controlled by a separate RPi, but connected to the control system RPi via two GPIO connections.</P><P>To interface the cameras, we use the <A href="https://picamera.readthedocs.io/en/release-1.13/">Python picamera library (v 1.13)</A>. Each camera is calibrated and set separately to maximize the difference between idle and activated state (i.e., basic and enhanced expression of fluorescent proteins). The raw RGB-data is recorded, the best channel is kept (e.g. the green channel when recording the fluorescence of mNeonGreen, the red channel when measuring mCardinal) and cropped to our region of interest—the bacterial suspension. The median intensity of this region is then compared to a threshold to decipher the bacterial command to the robot.</P></DIV></DIV><DIV class="section container"><H2 class="section-sub">Function</H2><DIV class="section-text container"><P>After having passed an <A href="https://2017.igem.org/Team:NAWI_Graz/Design#ims">interaction module</A>, bacterial suspension is transferred into the UV-cuvette in the interior of the chamber. The <A href="https://2017.igem.org/Team:NAWI_Graz/ControlSystem">control system</A> first excites the sample with one type of LED, records the fluorescence in the according camera, then switches to the other set of LEDs and the second camera (to avoid cross-polluting the readings). After the measurements are taken, the bacterial suspension is discarded.</P></DIV></DIV><DIV class="section container"><DIV class="section-sub-text"><B>Fig. 5:</B> A view of the assembled fluorescence measurement chamber with LEDs emitting blue light. The white ribbon cable at the bottom of the module indicates the connection to the second camera.
    </DIV></DIV><DIV class="section container"><H2 class="section-sub">Software</H2><DIV class="section-text container"><P>The code for the cameras is written as a module that can be imported and employed by the <A href="https://2017.igem.org/Team:NAWI_Graz/ControlSystem">control system</A>. Additionally, a debug mode was implemented that allows to export the camera recordings as images and elaborate logfiles. The control system only needs to start both scripts (the script for the <I>master camera</I> on the control system RPi itself and the <I>slave camera</I> on a different RPi). To measure, the control system only needs to invoke the dedicated method of the <I>master camera</I> object, which handles the control of and communication with the <I>slave camera</I>. Both scripts are shown below.</P><P>Camera Master:</P><DIV style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><TABLE><TBODY><TR><TD><PRE style="margin: 0; line-height: 125%">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387</PRE></TD><TD><PRE style="margin: 0; line-height: 125%"><SPAN style="color: #8f5902; font-style: italic">#!/usr/bin/env python</SPAN><SPAN style="color: #8f5902; font-style: italic">&quot;&quot;&quot;</SPAN><SPAN style="color: #8f5902; font-style: italic">Code for the master-camera.</SPAN><SPAN style="color: #8f5902; font-style: italic">It is connected to the slave-camera via 2 GPIO pins</SPAN><SPAN style="color: #8f5902; font-style: italic">and outputs the total detected bacterial state (aggregated</SPAN><SPAN style="color: #8f5902; font-style: italic">from both cameras).</SPAN><SPAN style="color: #8f5902; font-style: italic">@author: Daniel Hofstadler, 2017</SPAN><SPAN style="color: #8f5902; font-style: italic">&quot;&quot;&quot;</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">csv</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">time</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">argparse</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">gpiozero</SPAN><SPAN style="color: #204a87; font-weight: bold">from</SPAN><SPAN style="color: #000000">datetime</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">datetime</SPAN><SPAN style="color: #204a87; font-weight: bold">from</SPAN><SPAN style="color: #000000">fractions</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">Fraction</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">numpy</SPAN><SPAN style="color: #204a87; font-weight: bold">as</SPAN><SPAN style="color: #000000">np</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">picamera</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">picamera.array</SPAN><SPAN style="color: #204a87; font-weight: bold">from</SPAN><SPAN style="color: #000000">matplotlib</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">pyplot</SPAN><SPAN style="color: #204a87; font-weight: bold">as</SPAN><SPAN style="color: #000000">plt</SPAN><SPAN style="color: #8f5902; font-style: italic"># import warnings</SPAN><SPAN style="color: #8f5902; font-style: italic"># warnings.filterwarnings('error', category=DeprecationWarning)</SPAN><SPAN style="color: #8f5902; font-style: italic"># globals</SPAN><SPAN style="color: #8f5902; font-style: italic"># LOCAL_TZ = pytz.timezone(&quot;Etc/UTC&quot;)  # read from cams.csv</SPAN><SPAN style="color: #000000">OUT_APPEND</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;_coli&quot;</SPAN><SPAN style="color: #000000">CSV_NAME</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;colicam&quot;</SPAN><SPAN style="color: #000000">CSV_HEADER</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">&quot;framerate&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;exposure_time_us&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;iso&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;g1&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;g2&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;g3&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;g4&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;timestamp&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;time_utc&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;tag&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;red&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;green&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;blue&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #8f5902; font-style: italic"># RESOLUTION = (2592, 1944)</SPAN><SPAN style="color: #000000">RESOLUTION</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #0000cf; font-weight: bold">1280</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #0000cf; font-weight: bold">720</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #8f5902; font-style: italic"># REGION_OF_INTEREST = (0.35, 0.4, 0.5, 0.7)</SPAN><SPAN style="color: #000000">ROI</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">200</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #0000cf; font-weight: bold">520</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #0000cf; font-weight: bold">480</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #0000cf; font-weight: bold">800</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #8f5902; font-style: italic"># Y0, Y1, X0, X1</SPAN><SPAN style="color: #000000">DETECTION_THRESHOLD</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">150</SPAN><SPAN style="color: #000000">PIN_RX</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">17</SPAN><SPAN style="color: #000000">PIN_TX</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">18</SPAN><SPAN style="color: #000000">SETTINGS_FIXED</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000; font-weight: bold">{</SPAN><SPAN style="color: #4e9a06">'name'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #4e9a06">&quot;fixed&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">'ss'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #0000cf; font-weight: bold">1000000</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #8f5902; font-style: italic"># 1000 milliseconds = 1 sec</SPAN><SPAN style="color: #4e9a06">'fps'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">Fraction</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #0000cf; font-weight: bold">2</SPAN><SPAN style="color: #000000; font-weight: bold">),</SPAN><SPAN style="color: #8f5902; font-style: italic"># (1, 2)</SPAN><SPAN style="color: #4e9a06">'iso'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #0000cf; font-weight: bold">800</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #8f5902; font-style: italic"># 800</SPAN><SPAN style="color: #4e9a06">'g'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">Fraction</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #0000cf; font-weight: bold">2</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">),</SPAN><SPAN style="color: #000000">Fraction</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">)),</SPAN><SPAN style="color: #8f5902; font-style: italic"># 'g': (Fraction(345, 256), Fraction(167, 128)),</SPAN><SPAN style="color: #4e9a06">'sleep'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #0000cf; font-weight: bold">15</SPAN><SPAN style="color: #000000; font-weight: bold">}</SPAN><SPAN style="color: #8f5902; font-style: italic"># 10</SPAN><SPAN style="color: #000000">SETTINGS_SENSITIVE</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000; font-weight: bold">{</SPAN><SPAN style="color: #4e9a06">'name'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #4e9a06">&quot;sensitive&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">'ss'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #0000cf; font-weight: bold">6000000</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #8f5902; font-style: italic"># 6 seconds</SPAN><SPAN style="color: #4e9a06">'fps'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">Fraction</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #0000cf; font-weight: bold">6</SPAN><SPAN style="color: #000000; font-weight: bold">),</SPAN><SPAN style="color: #4e9a06">'iso'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #0000cf; font-weight: bold">800</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">'g'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #3465a4">None</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">'sleep'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #0000cf; font-weight: bold">30</SPAN><SPAN style="color: #000000; font-weight: bold">}</SPAN><SPAN style="color: #000000">SETTINGS_AUTO</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000; font-weight: bold">{</SPAN><SPAN style="color: #4e9a06">'name'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #4e9a06">&quot;auto&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">'ss'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #3465a4">None</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">'fps'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #0000cf; font-weight: bold">30</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">'iso'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">'g'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #3465a4">None</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">'sleep'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #0000cf; font-weight: bold">2</SPAN><SPAN style="color: #000000; font-weight: bold">}</SPAN><SPAN style="color: #000000">SETTINGS_DEFAULT</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;fixed&quot;</SPAN><SPAN style="color: #8f5902; font-style: italic"># argument parsing</SPAN><SPAN style="color: #000000">parser</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">argparse</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">ArgumentParser</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">description</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;Colibot Photometer Camera.&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">parser</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">add_argument</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;-d&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;--debug&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">action</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;store_true&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">help</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;debug mode&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">parser</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">add_argument</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;-m&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;--mode&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #204a87">type</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #204a87">str</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">default</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;fixed&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">choices</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">&quot;f&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;fixed&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;s&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;sensitive&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;a&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;auto&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000">help</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;set the camera mode&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">parser</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">add_argument</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;-p&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;--postfix&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #204a87">type</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #204a87">str</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">default</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">help</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;add string to filename&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #8f5902; font-style: italic"># args = vars(ap.parse_args())</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">parser</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">parse_args</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #204a87; font-weight: bold">not</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #4e9a06">&quot;&quot;</SPAN><SPAN style="color: #204a87; font-weight: bold">and</SPAN><SPAN style="color: #204a87; font-weight: bold">not</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">startswith</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;_&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;_&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">+</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #204a87; font-weight: bold">def</SPAN><SPAN style="color: #000000">now_str</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">pattern</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;_%y%m%d-%H%M%S_utc&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #8f5902; font-style: italic"># return time.strftime(pattern, time.gmtime())</SPAN><SPAN style="color: #204a87; font-weight: bold">return</SPAN><SPAN style="color: #000000">datetime</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">utcnow</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">strftime</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">pattern</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">def</SPAN><SPAN style="color: #000000">from_timestamp</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">ts</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">pattern</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;%y%m%d-%H%M%S_utc&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #204a87; font-weight: bold">return</SPAN><SPAN style="color: #000000">datetime</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">utcfromtimestamp</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">ts</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">strftime</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">pattern</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">def</SPAN><SPAN style="color: #000000">safename</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">s</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">s_type</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #8f5902; font-style: italic">&quot;&quot;&quot;Check whether a given file or folder 's' exists, return a non-existing</SPAN><SPAN style="color: #8f5902; font-style: italic">    filename.</SPAN><SPAN style="color: #8f5902; font-style: italic">    s ........ (full) filename or directory</SPAN><SPAN style="color: #8f5902; font-style: italic">    s_type ... 'file' or 'f' for files,</SPAN><SPAN style="color: #8f5902; font-style: italic">'directory' or 'dir' or 'd' for folders</SPAN><SPAN style="color: #8f5902; font-style: italic">    Returns a file- or pathname that is supposedly safe to save</SPAN><SPAN style="color: #8f5902; font-style: italic">    without overwriting data.</SPAN><SPAN style="color: #8f5902; font-style: italic">&quot;&quot;&quot;</SPAN><SPAN style="color: #000000">low_type</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #204a87">str</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">lower</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">s_type</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">low_type</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #4e9a06">'file'</SPAN><SPAN style="color: #204a87; font-weight: bold">or</SPAN><SPAN style="color: #000000">low_type</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #4e9a06">'f'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">path</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">isfile</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">s</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">s2</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">s</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">split</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">'.'</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">s_base</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">s2</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #000000">s_ext</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">s2</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #ce5c00; font-weight: bold">-</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #000000">counter</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #204a87; font-weight: bold">while</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">path</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">isfile</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">s</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">s</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">s_base</SPAN><SPAN style="color: #ce5c00; font-weight: bold">+</SPAN><SPAN style="color: #4e9a06">&quot;-{:02d}.&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">counter</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #ce5c00; font-weight: bold">+</SPAN><SPAN style="color: #000000">s_ext</SPAN><SPAN style="color: #000000">counter</SPAN><SPAN style="color: #ce5c00; font-weight: bold">+=</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #204a87; font-weight: bold">elif</SPAN><SPAN style="color: #000000">low_type</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #4e9a06">'directory'</SPAN><SPAN style="color: #204a87; font-weight: bold">or</SPAN><SPAN style="color: #000000">low_type</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #4e9a06">'dir'</SPAN><SPAN style="color: #204a87; font-weight: bold">or</SPAN><SPAN style="color: #000000">low_type</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #4e9a06">'d'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">path</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">isdir</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">s</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">s_base</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">s</SPAN><SPAN style="color: #000000">counter</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #204a87; font-weight: bold">while</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">path</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">isdir</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">s</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">s</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">s_base</SPAN><SPAN style="color: #ce5c00; font-weight: bold">+</SPAN><SPAN style="color: #4e9a06">&quot;-{:02d}&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">counter</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">counter</SPAN><SPAN style="color: #ce5c00; font-weight: bold">+=</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #204a87; font-weight: bold">return</SPAN><SPAN style="color: #000000">s</SPAN><SPAN style="color: #204a87; font-weight: bold">class</SPAN><SPAN style="color: #000000">ColiCamMaster</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">RESOLUTION</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">ROI</SPAN><SPAN style="color: #8f5902; font-style: italic"># REGION_OF_INTEREST</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">DETECTION_THRESHOLD</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">SETTINGS_FIXED</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">SETTINGS_SENSITIVE</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">SETTINGS_AUTO</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">DEF_SETTINGS_NAME</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">PIN_RX</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">PIN_TX</SPAN><SPAN style="color: #204a87; font-weight: bold">def</SPAN><SPAN style="color: #000000">__init__</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">resolution</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">RESOLUTION</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">DEF_SETTINGS_NAME</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #204a87; font-weight: bold">try</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">picamera</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">PiCamera</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">resolution</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">resolution</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">set_cam</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">except</SPAN><SPAN style="color: #cc0000; font-weight: bold">Exception</SPAN><SPAN style="color: #204a87; font-weight: bold">as</SPAN><SPAN style="color: #000000">err</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;&quot;</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;couldn't initialize camera, error: {}&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">err</SPAN><SPAN style="color: #000000; font-weight: bold">))</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">rx</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">gpiozero</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">InputDevice</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">PIN_RX</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">tx</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">gpiozero</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">OutputDevice</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">PIN_TX</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">def</SPAN><SPAN style="color: #000000">set_cam</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;fixed&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">lower</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">startswith</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;f&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">SETTINGS_FIXED</SPAN><SPAN style="color: #204a87; font-weight: bold">elif</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">lower</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">startswith</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;s&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">SETTINGS_SENSITIVE</SPAN><SPAN style="color: #204a87; font-weight: bold">elif</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">lower</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">startswith</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;a&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">SETTINGS_AUTO</SPAN><SPAN style="color: #204a87; font-weight: bold">else</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;wrong camera mode&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #8f5902; font-style: italic"># switch on auto mode</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">awb_mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">'auto'</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">exposure_mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">'auto'</SPAN><SPAN style="color: #8f5902; font-style: italic"># settings = dict with fields: name, ss, fps, iso, g, sleep</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">framerate</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">'fps'</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">'ss'</SPAN><SPAN style="color: #000000; font-weight: bold">]:</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">shutter_speed</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">'ss'</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">iso</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">'iso'</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #8f5902; font-style: italic"># Wait for the automatic gain control to settle</SPAN><SPAN style="color: #000000">time</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">sleep</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">'sleep'</SPAN><SPAN style="color: #000000; font-weight: bold">])</SPAN><SPAN style="color: #8f5902; font-style: italic"># Now fix the values</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #204a87; font-weight: bold">not</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">'ss'</SPAN><SPAN style="color: #000000; font-weight: bold">]:</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">shutter_speed</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">exposure_speed</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">exposure_mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">'off'</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">'g'</SPAN><SPAN style="color: #000000; font-weight: bold">]:</SPAN><SPAN style="color: #000000">g</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">'g'</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #204a87; font-weight: bold">else</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">g</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">awb_gains</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">awb_mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">'off'</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">awb_gains</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">g</SPAN><SPAN style="color: #204a87; font-weight: bold">def</SPAN><SPAN style="color: #000000">measure</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">roi</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">ROI</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">channel_name</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;green&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">threshold</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">DETECTION_THRESHOLD</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">None</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">csv_out</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">None</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #8f5902; font-style: italic"># notify other camera to take a picture</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">tx</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">on</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #8f5902; font-style: italic"># check whether channel is valid</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">channel_name</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">lower</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">startswith</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;r&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">channel</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000">channel_name</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;red&quot;</SPAN><SPAN style="color: #204a87; font-weight: bold">elif</SPAN><SPAN style="color: #000000">channel_name</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">lower</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">startswith</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;g&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">channel</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000">channel_name</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;green&quot;</SPAN><SPAN style="color: #204a87; font-weight: bold">elif</SPAN><SPAN style="color: #000000">channel_name</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">lower</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">startswith</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;b&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">channel</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">2</SPAN><SPAN style="color: #000000">channel_name</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;blue&quot;</SPAN><SPAN style="color: #204a87; font-weight: bold">else</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;wrong channel_name: '{}'&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">channel_name</SPAN><SPAN style="color: #000000; font-weight: bold">))</SPAN><SPAN style="color: #8f5902; font-style: italic"># get camera settings</SPAN><SPAN style="color: #000000">time</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">sleep</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">fps</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #204a87">float</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">framerate</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">ss</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">exposure_speed</SPAN><SPAN style="color: #000000">g</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">awb_gains</SPAN><SPAN style="color: #000000">g1</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">g</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">numerator</SPAN><SPAN style="color: #000000">g2</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">g</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">denominator</SPAN><SPAN style="color: #000000">g3</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">g</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">numerator</SPAN><SPAN style="color: #000000">g4</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">g</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">denominator</SPAN><SPAN style="color: #000000">iso</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">iso</SPAN><SPAN style="color: #000000">settings_str</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;ss{}_g{}-{}_{}-{}_iso{}_&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">ss</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">g1</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">g2</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">g3</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">g4</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">iso</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">csv_row</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #000000">fps</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">ss</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">iso</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">g1</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">g2</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">g3</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">g4</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;taking photos with settings: {}&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">settings_str</SPAN><SPAN style="color: #000000; font-weight: bold">))</SPAN><SPAN style="color: #8f5902; font-style: italic"># with picamera.PiCamera(resolution=RESOLUTION) as cam:</SPAN><SPAN style="color: #8f5902; font-style: italic"># https://picamera.readthedocs.io/en/latest/</SPAN><SPAN style="color: #8f5902; font-style: italic">#         api_array.html#module-picamera.array</SPAN><SPAN style="color: #204a87; font-weight: bold">with</SPAN><SPAN style="color: #000000">picamera</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">array</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">PiRGBArray</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">as</SPAN><SPAN style="color: #000000">output</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #8f5902; font-style: italic"># cam.zoom = REGION_OF_INTEREST</SPAN><SPAN style="color: #8f5902; font-style: italic"># cam.start_preview()</SPAN><SPAN style="color: #8f5902; font-style: italic"># take picture</SPAN><SPAN style="color: #000000">t0</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">time</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">time</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">capture</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">output</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;rgb&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">a</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">output</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">array</SPAN><SPAN style="color: #000000">t1</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">time</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">time</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;recorded for {} sec&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #204a87">round</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">t1</SPAN><SPAN style="color: #ce5c00; font-weight: bold">-</SPAN><SPAN style="color: #000000">t0</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #0000cf; font-weight: bold">2</SPAN><SPAN style="color: #000000; font-weight: bold">)))</SPAN><SPAN style="color: #000000">t_pic</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #204a87">int</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #204a87">round</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">np</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">mean</SPAN><SPAN style="color: #000000; font-weight: bold">([</SPAN><SPAN style="color: #000000">t0</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">t1</SPAN><SPAN style="color: #000000; font-weight: bold">])))</SPAN><SPAN style="color: #8f5902; font-style: italic"># re-empty output (to reuse next iteration)</SPAN><SPAN style="color: #8f5902; font-style: italic"># output.truncate(0)</SPAN><SPAN style="color: #8f5902; font-style: italic"># crop to region of interest</SPAN><SPAN style="color: #000000">roi</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">a</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #000000">ROI</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">]:</SPAN><SPAN style="color: #000000">ROI</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000">ROI</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">2</SPAN><SPAN style="color: #000000; font-weight: bold">]:</SPAN><SPAN style="color: #000000">ROI</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">3</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000; font-weight: bold">:]</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000; font-weight: bold">[]</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">append</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">np</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">median</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">roi</SPAN><SPAN style="color: #000000; font-weight: bold">[:,</SPAN><SPAN style="color: #000000; font-weight: bold">:,</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">]))</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">append</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">np</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">median</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">roi</SPAN><SPAN style="color: #000000; font-weight: bold">[:,</SPAN><SPAN style="color: #000000; font-weight: bold">:,</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">]))</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">append</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">np</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">median</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">roi</SPAN><SPAN style="color: #000000; font-weight: bold">[:,</SPAN><SPAN style="color: #000000; font-weight: bold">:,</SPAN><SPAN style="color: #0000cf; font-weight: bold">2</SPAN><SPAN style="color: #000000; font-weight: bold">]))</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">((</SPAN><SPAN style="color: #4e9a06">&quot;roi.shape={},\n&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">+</SPAN><SPAN style="color: #8f5902; font-style: italic"># &quot;sum(red)={}, sum(green)={}, sum(blue)={},\n&quot; +</SPAN><SPAN style="color: #4e9a06">&quot;med(red)={}, med(green)={}, med(blue)={}&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">roi</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">shape</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">2</SPAN><SPAN style="color: #000000; font-weight: bold">]))</SPAN><SPAN style="color: #000000">val</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #000000">channel</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;reading the {} channel...\nvalue: {}&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">channel_name</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">val</SPAN><SPAN style="color: #000000; font-weight: bold">))</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">val</SPAN><SPAN style="color: #ce5c00; font-weight: bold">&gt;=</SPAN><SPAN style="color: #000000">threshold</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">activated</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">True</SPAN><SPAN style="color: #204a87; font-weight: bold">else</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">activated</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">False</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;active={} (threshold: {})&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">activated</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">threshold</SPAN><SPAN style="color: #000000; font-weight: bold">))</SPAN><SPAN style="color: #8f5902; font-style: italic"># debug mode:</SPAN><SPAN style="color: #8f5902; font-style: italic"># output images and csv if output directory exists</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">names</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">&quot;1-red&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;2-green&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;3-blue&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #8f5902; font-style: italic"># whole images</SPAN><SPAN style="color: #000000">fn</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;full_{}{}_0-rgb{}.png&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">settings_str</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">now_str</SPAN><SPAN style="color: #000000; font-weight: bold">())</SPAN><SPAN style="color: #000000">ffn</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">safename</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">path</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">join</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">fn</SPAN><SPAN style="color: #000000; font-weight: bold">),</SPAN><SPAN style="color: #4e9a06">&quot;file&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">plt</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">imsave</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">ffn</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">a</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">for</SPAN><SPAN style="color: #000000">i</SPAN><SPAN style="color: #204a87; font-weight: bold">in</SPAN><SPAN style="color: #204a87">range</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #0000cf; font-weight: bold">3</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">fn</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;full_{}{}_{}{}.png&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">settings_str</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">names</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #000000">i</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000">now_str</SPAN><SPAN style="color: #000000; font-weight: bold">())</SPAN><SPAN style="color: #000000">ffn</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">safename</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">path</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">join</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">fn</SPAN><SPAN style="color: #000000; font-weight: bold">),</SPAN><SPAN style="color: #4e9a06">&quot;file&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">plt</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">imsave</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">ffn</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">a</SPAN><SPAN style="color: #000000; font-weight: bold">[:,</SPAN><SPAN style="color: #000000; font-weight: bold">:,</SPAN><SPAN style="color: #000000">i</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000">vmin</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">vmax</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">255</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #8f5902; font-style: italic"># cropped to ROI</SPAN><SPAN style="color: #000000">fn</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;roi_{}{}_0-rgb{}.png&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">settings_str</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">now_str</SPAN><SPAN style="color: #000000; font-weight: bold">())</SPAN><SPAN style="color: #000000">ffn</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">safename</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">path</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">join</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">fn</SPAN><SPAN style="color: #000000; font-weight: bold">),</SPAN><SPAN style="color: #4e9a06">&quot;file&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">plt</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">imsave</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">ffn</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">roi</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">for</SPAN><SPAN style="color: #000000">i</SPAN><SPAN style="color: #204a87; font-weight: bold">in</SPAN><SPAN style="color: #204a87">range</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #0000cf; font-weight: bold">3</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">fn</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;roi_{}{}_{}{}.png&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">settings_str</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">names</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #000000">i</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000">now_str</SPAN><SPAN style="color: #000000; font-weight: bold">())</SPAN><SPAN style="color: #000000">ffn</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">safename</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">path</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">join</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">fn</SPAN><SPAN style="color: #000000; font-weight: bold">),</SPAN><SPAN style="color: #4e9a06">&quot;file&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">plt</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">imsave</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">ffn</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">roi</SPAN><SPAN style="color: #000000; font-weight: bold">[:,</SPAN><SPAN style="color: #000000; font-weight: bold">:,</SPAN><SPAN style="color: #000000">i</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000">vmin</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">vmax</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">255</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">csv_row</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">extend</SPAN><SPAN style="color: #000000; font-weight: bold">([</SPAN><SPAN style="color: #000000">t_pic</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">from_timestamp</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">t_pic</SPAN><SPAN style="color: #000000; font-weight: bold">),</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">2</SPAN><SPAN style="color: #000000; font-weight: bold">]])</SPAN><SPAN style="color: #204a87; font-weight: bold">with</SPAN><SPAN style="color: #204a87">open</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">csv_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;at&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">as</SPAN><SPAN style="color: #000000">csvfile</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">csvwriter</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">csv</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">writer</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">csvfile</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">csvwriter</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">writerow</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">csv_row</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;wrote csv_row: {}&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">csv_row</SPAN><SPAN style="color: #000000; font-weight: bold">))</SPAN><SPAN style="color: #8f5902; font-style: italic"># read state of the slave-camera</SPAN><SPAN style="color: #000000">other_activated</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">False</SPAN><SPAN style="color: #8f5902; font-style: italic"># impossible that both are active!</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #204a87; font-weight: bold">not</SPAN><SPAN style="color: #000000">activated</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">timeout</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">time</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">time</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #ce5c00; font-weight: bold">+</SPAN><SPAN style="color: #0000cf; font-weight: bold">2</SPAN><SPAN style="color: #8f5902; font-style: italic"># seconds</SPAN><SPAN style="color: #204a87; font-weight: bold">while</SPAN><SPAN style="color: #204a87; font-weight: bold">not</SPAN><SPAN style="color: #000000">other_activated</SPAN><SPAN style="color: #204a87; font-weight: bold">and</SPAN><SPAN style="color: #000000">time</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">time</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #ce5c00; font-weight: bold">&lt;</SPAN><SPAN style="color: #000000">timeout</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">other_activated</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">rx</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">is_active</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">tx</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">off</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #8f5902; font-style: italic"># determine final state</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">activated</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">output</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #204a87; font-weight: bold">elif</SPAN><SPAN style="color: #000000">other_activated</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">output</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #ce5c00; font-weight: bold">-</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #204a87; font-weight: bold">else</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">output</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #204a87; font-weight: bold">return</SPAN><SPAN style="color: #000000">output</SPAN><SPAN style="color: #204a87; font-weight: bold">def</SPAN><SPAN style="color: #000000">exit_clean</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #204a87; font-weight: bold">not</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #4e9a06">&quot;&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">close</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #204a87; font-weight: bold">def</SPAN><SPAN style="color: #000000">main</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">CSV_NAME</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">CSV_HEADER</SPAN><SPAN style="color: #8f5902; font-style: italic"># t0 = time.time()</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">ColiCamMaster</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #8f5902; font-style: italic"># t_cam = time.time() - t0</SPAN><SPAN style="color: #8f5902; font-style: italic"># select mode (camera settings)</SPAN><SPAN style="color: #000000">current_mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #8f5902; font-style: italic"># optionally create output directory for debugging</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">debug</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #8f5902; font-style: italic"># setup output directory (and copy over the code?)</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;/home/pi/ColiCam_{}&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">now_str</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;%y%m%d&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">))</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">safename</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;dir&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #204a87; font-weight: bold">not</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">path</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">isdir</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">mkdir</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;outputting to '{}'&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">))</SPAN><SPAN style="color: #8f5902; font-style: italic"># initialize csv-log</SPAN><SPAN style="color: #000000">csv_fn</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;{}{}{}.csv&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">CSV_NAME</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">now_str</SPAN><SPAN style="color: #000000; font-weight: bold">())</SPAN><SPAN style="color: #000000">csv_out</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">safename</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">path</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">join</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">csv_fn</SPAN><SPAN style="color: #000000; font-weight: bold">),</SPAN><SPAN style="color: #4e9a06">'file'</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #8f5902; font-style: italic"># write header</SPAN><SPAN style="color: #204a87; font-weight: bold">with</SPAN><SPAN style="color: #204a87">open</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">csv_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;wt&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">as</SPAN><SPAN style="color: #000000">csvfile</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">csvwriter</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">csv</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">writer</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">csvfile</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">csvwriter</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">writerow</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">CSV_HEADER</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;initialized {} with header {}&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">csv_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">CSV_HEADER</SPAN><SPAN style="color: #000000; font-weight: bold">))</SPAN><SPAN style="color: #204a87; font-weight: bold">else</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">None</SPAN><SPAN style="color: #000000">csv_out</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">None</SPAN><SPAN style="color: #8f5902; font-style: italic"># it = 0</SPAN><SPAN style="color: #204a87; font-weight: bold">try</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">while</SPAN><SPAN style="color: #3465a4">True</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #8f5902; font-style: italic"># it += 1</SPAN><SPAN style="color: #8f5902; font-style: italic"># update mode</SPAN><SPAN style="color: #000000">new_mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #204a87; font-weight: bold">not</SPAN><SPAN style="color: #000000">current_mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #000000">new_mode</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">set_cam</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">new_mode</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #8f5902; font-style: italic"># cam.set_cam(mode=args.mode)</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;measuring in {} mode (default):&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #000000; font-weight: bold">))</SPAN><SPAN style="color: #8f5902; font-style: italic"># measure with both cams</SPAN><SPAN style="color: #000000">val</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">measure</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">csv_out</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">csv_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">val</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #ce5c00; font-weight: bold">-</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;wall on the left\n&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">elif</SPAN><SPAN style="color: #000000">val</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;no wall detected\n&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">elif</SPAN><SPAN style="color: #000000">val</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;wall on the right\n&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">except</SPAN><SPAN style="color: #cc0000; font-weight: bold">KeyboardInterrupt</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;manually interrupted program&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">finally</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">exit_clean</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;camera closed, done!&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">__name__</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #4e9a06">&quot;__main__&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">main</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN></PRE></TD></TR></TBODY></TABLE></DIV><P>Camera Slave:</P><DIV style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><TABLE><TBODY><TR><TD><PRE style="margin: 0; line-height: 125%">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399</PRE></TD><TD><PRE style="margin: 0; line-height: 125%"><SPAN style="color: #8f5902; font-style: italic">#!/usr/bin/env python</SPAN><SPAN style="color: #8f5902; font-style: italic">&quot;&quot;&quot;</SPAN><SPAN style="color: #8f5902; font-style: italic">Code for the slave-camera</SPAN><SPAN style="color: #8f5902; font-style: italic">It is connected to the master-camera via 2 GPIO pins</SPAN><SPAN style="color: #8f5902; font-style: italic">and outputs the detected bacterial state via the</SPAN><SPAN style="color: #8f5902; font-style: italic">GPIO-connection to the master-camera.</SPAN><SPAN style="color: #8f5902; font-style: italic">In order to constantly listen for commands from the</SPAN><SPAN style="color: #8f5902; font-style: italic">master camera, it needs to start a background-</SPAN><SPAN style="color: #8f5902; font-style: italic">thread.</SPAN><SPAN style="color: #8f5902; font-style: italic">@author: Daniel Hofstadler, 2017</SPAN><SPAN style="color: #8f5902; font-style: italic">&quot;&quot;&quot;</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">csv</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">time</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">argparse</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">gpiozero</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">threading</SPAN><SPAN style="color: #204a87; font-weight: bold">from</SPAN><SPAN style="color: #000000">datetime</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">datetime</SPAN><SPAN style="color: #204a87; font-weight: bold">from</SPAN><SPAN style="color: #000000">fractions</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">Fraction</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">numpy</SPAN><SPAN style="color: #204a87; font-weight: bold">as</SPAN><SPAN style="color: #000000">np</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">picamera</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">picamera.array</SPAN><SPAN style="color: #204a87; font-weight: bold">from</SPAN><SPAN style="color: #000000">matplotlib</SPAN><SPAN style="color: #204a87; font-weight: bold">import</SPAN><SPAN style="color: #000000">pyplot</SPAN><SPAN style="color: #204a87; font-weight: bold">as</SPAN><SPAN style="color: #000000">plt</SPAN><SPAN style="color: #8f5902; font-style: italic"># import warnings</SPAN><SPAN style="color: #8f5902; font-style: italic"># warnings.filterwarnings('error', category=DeprecationWarning)</SPAN><SPAN style="color: #8f5902; font-style: italic"># globals</SPAN><SPAN style="color: #8f5902; font-style: italic"># LOCAL_TZ = pytz.timezone(&quot;Etc/UTC&quot;)  # read from cams.csv</SPAN><SPAN style="color: #000000">OUT_APPEND</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;_coli&quot;</SPAN><SPAN style="color: #000000">CSV_NAME</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;colicam&quot;</SPAN><SPAN style="color: #000000">CSV_HEADER</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">&quot;framerate&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;exposure_time_us&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;iso&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;g1&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;g2&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;g3&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;g4&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;timestamp&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;time_utc&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;tag&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;red&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;green&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;blue&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #8f5902; font-style: italic"># RESOLUTION = (2592, 1944)</SPAN><SPAN style="color: #000000">RESOLUTION</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #0000cf; font-weight: bold">1280</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #0000cf; font-weight: bold">720</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #8f5902; font-style: italic"># REGION_OF_INTEREST = (0.35, 0.4, 0.5, 0.7)</SPAN><SPAN style="color: #000000">ROI</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">200</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #0000cf; font-weight: bold">520</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #0000cf; font-weight: bold">480</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #0000cf; font-weight: bold">800</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #8f5902; font-style: italic"># Y0, Y1, X0, X1</SPAN><SPAN style="color: #000000">DETECTION_THRESHOLD</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">150</SPAN><SPAN style="color: #000000">PIN_RX</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">17</SPAN><SPAN style="color: #000000">PIN_TX</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">18</SPAN><SPAN style="color: #000000">SETTINGS_FIXED</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000; font-weight: bold">{</SPAN><SPAN style="color: #4e9a06">'name'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #4e9a06">&quot;fixed&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">'ss'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #0000cf; font-weight: bold">1000000</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #8f5902; font-style: italic"># 1000 milliseconds = 1 sec</SPAN><SPAN style="color: #4e9a06">'fps'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">Fraction</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #0000cf; font-weight: bold">2</SPAN><SPAN style="color: #000000; font-weight: bold">),</SPAN><SPAN style="color: #8f5902; font-style: italic"># (1, 2)</SPAN><SPAN style="color: #4e9a06">'iso'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #0000cf; font-weight: bold">800</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #8f5902; font-style: italic"># 800</SPAN><SPAN style="color: #4e9a06">'g'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">Fraction</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #0000cf; font-weight: bold">2</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">),</SPAN><SPAN style="color: #000000">Fraction</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">)),</SPAN><SPAN style="color: #8f5902; font-style: italic"># 'g': (Fraction(345, 256), Fraction(167, 128)),</SPAN><SPAN style="color: #4e9a06">'sleep'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #0000cf; font-weight: bold">15</SPAN><SPAN style="color: #000000; font-weight: bold">}</SPAN><SPAN style="color: #8f5902; font-style: italic"># 10</SPAN><SPAN style="color: #000000">SETTINGS_SENSITIVE</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000; font-weight: bold">{</SPAN><SPAN style="color: #4e9a06">'name'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #4e9a06">&quot;sensitive&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">'ss'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #0000cf; font-weight: bold">6000000</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #8f5902; font-style: italic"># 6 seconds</SPAN><SPAN style="color: #4e9a06">'fps'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">Fraction</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #0000cf; font-weight: bold">6</SPAN><SPAN style="color: #000000; font-weight: bold">),</SPAN><SPAN style="color: #4e9a06">'iso'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #0000cf; font-weight: bold">800</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">'g'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #3465a4">None</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">'sleep'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #0000cf; font-weight: bold">30</SPAN><SPAN style="color: #000000; font-weight: bold">}</SPAN><SPAN style="color: #000000">SETTINGS_AUTO</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000; font-weight: bold">{</SPAN><SPAN style="color: #4e9a06">'name'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #4e9a06">&quot;auto&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">'ss'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #3465a4">None</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">'fps'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #0000cf; font-weight: bold">30</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">'iso'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">'g'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #3465a4">None</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">'sleep'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #0000cf; font-weight: bold">2</SPAN><SPAN style="color: #000000; font-weight: bold">}</SPAN><SPAN style="color: #000000">SETTINGS_DEFAULT</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;fixed&quot;</SPAN><SPAN style="color: #8f5902; font-style: italic"># argument parsing</SPAN><SPAN style="color: #000000">parser</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">argparse</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">ArgumentParser</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">description</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;Colibot Photometer Camera.&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">parser</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">add_argument</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;-d&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;--debug&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">action</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;store_true&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">help</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;debug mode&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">parser</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">add_argument</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;-m&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;--mode&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #204a87">type</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #204a87">str</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">default</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;fixed&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">choices</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">&quot;f&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;fixed&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;s&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;sensitive&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;a&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;auto&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000">help</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;set the camera mode&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">parser</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">add_argument</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;-p&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;--postfix&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #204a87">type</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #204a87">str</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">default</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">help</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;add string to filename&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #8f5902; font-style: italic"># args = vars(ap.parse_args())</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">parser</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">parse_args</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #204a87; font-weight: bold">not</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #4e9a06">&quot;&quot;</SPAN><SPAN style="color: #204a87; font-weight: bold">and</SPAN><SPAN style="color: #204a87; font-weight: bold">not</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">startswith</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;_&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;_&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">+</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #204a87; font-weight: bold">def</SPAN><SPAN style="color: #000000">now_str</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">pattern</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;_%y%m%d-%H%M%S_utc&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #8f5902; font-style: italic"># return time.strftime(pattern, time.gmtime())</SPAN><SPAN style="color: #204a87; font-weight: bold">return</SPAN><SPAN style="color: #000000">datetime</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">utcnow</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">strftime</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">pattern</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">def</SPAN><SPAN style="color: #000000">from_timestamp</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">ts</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">pattern</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;%y%m%d-%H%M%S_utc&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #204a87; font-weight: bold">return</SPAN><SPAN style="color: #000000">datetime</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">utcfromtimestamp</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">ts</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">strftime</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">pattern</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">def</SPAN><SPAN style="color: #000000">safename</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">s</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">s_type</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #8f5902; font-style: italic">&quot;&quot;&quot;Check whether a given file or folder 's' exists, return a non-existing</SPAN><SPAN style="color: #8f5902; font-style: italic">    filename.</SPAN><SPAN style="color: #8f5902; font-style: italic">    s ........ (full) filename or directory</SPAN><SPAN style="color: #8f5902; font-style: italic">    s_type ... 'file' or 'f' for files,</SPAN><SPAN style="color: #8f5902; font-style: italic">'directory' or 'dir' or 'd' for folders</SPAN><SPAN style="color: #8f5902; font-style: italic">    Returns a file- or pathname that is supposedly safe to save</SPAN><SPAN style="color: #8f5902; font-style: italic">    without overwriting data.</SPAN><SPAN style="color: #8f5902; font-style: italic">&quot;&quot;&quot;</SPAN><SPAN style="color: #000000">low_type</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #204a87">str</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">lower</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">s_type</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">low_type</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #4e9a06">'file'</SPAN><SPAN style="color: #204a87; font-weight: bold">or</SPAN><SPAN style="color: #000000">low_type</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #4e9a06">'f'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">path</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">isfile</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">s</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">s2</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">s</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">split</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">'.'</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">s_base</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">s2</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #000000">s_ext</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">s2</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #ce5c00; font-weight: bold">-</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #000000">counter</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #204a87; font-weight: bold">while</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">path</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">isfile</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">s</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">s</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">s_base</SPAN><SPAN style="color: #ce5c00; font-weight: bold">+</SPAN><SPAN style="color: #4e9a06">&quot;-{:02d}.&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">counter</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #ce5c00; font-weight: bold">+</SPAN><SPAN style="color: #000000">s_ext</SPAN><SPAN style="color: #000000">counter</SPAN><SPAN style="color: #ce5c00; font-weight: bold">+=</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #204a87; font-weight: bold">elif</SPAN><SPAN style="color: #000000">low_type</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #4e9a06">'directory'</SPAN><SPAN style="color: #204a87; font-weight: bold">or</SPAN><SPAN style="color: #000000">low_type</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #4e9a06">'dir'</SPAN><SPAN style="color: #204a87; font-weight: bold">or</SPAN><SPAN style="color: #000000">low_type</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #4e9a06">'d'</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">path</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">isdir</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">s</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">s_base</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">s</SPAN><SPAN style="color: #000000">counter</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #204a87; font-weight: bold">while</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">path</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">isdir</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">s</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">s</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">s_base</SPAN><SPAN style="color: #ce5c00; font-weight: bold">+</SPAN><SPAN style="color: #4e9a06">&quot;-{:02d}&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">counter</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">counter</SPAN><SPAN style="color: #ce5c00; font-weight: bold">+=</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #204a87; font-weight: bold">return</SPAN><SPAN style="color: #000000">s</SPAN><SPAN style="color: #204a87; font-weight: bold">def</SPAN><SPAN style="color: #000000">thread_listener</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #8f5902; font-style: italic">&quot;&quot;&quot;Background thread listening on the receive-pin</SPAN><SPAN style="color: #8f5902; font-style: italic">    whether to make a measurement.&quot;&quot;&quot;</SPAN><SPAN style="color: #204a87; font-weight: bold">try</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">while</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">active</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">rx</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">is_active</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">measure_slave</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #000000">time</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">sleep</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #0000cf; font-weight: bold">0.5</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">finally</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;listener thread shutting down&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">class</SPAN><SPAN style="color: #000000">ColiCamSlave</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">RESOLUTION</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">ROI</SPAN><SPAN style="color: #8f5902; font-style: italic"># REGION_OF_INTEREST</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">DETECTION_THRESHOLD</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">SETTINGS_FIXED</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">SETTINGS_SENSITIVE</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">SETTINGS_AUTO</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">DEF_SETTINGS_NAME</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">PIN_RX</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">PIN_TX</SPAN><SPAN style="color: #204a87; font-weight: bold">def</SPAN><SPAN style="color: #000000">__init__</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">resolution</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">RESOLUTION</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">DEF_SETTINGS_NAME</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #204a87; font-weight: bold">try</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">picamera</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">PiCamera</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">resolution</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">resolution</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">set_cam</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">except</SPAN><SPAN style="color: #cc0000; font-weight: bold">Exception</SPAN><SPAN style="color: #204a87; font-weight: bold">as</SPAN><SPAN style="color: #000000">err</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;&quot;</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;couldn't initialize camera, error: {}&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">err</SPAN><SPAN style="color: #000000; font-weight: bold">))</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">rx</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">gpiozero</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">InputDevice</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">PIN_RX</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">tx</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">gpiozero</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">OutputDevice</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">PIN_TX</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">active</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">True</SPAN><SPAN style="color: #8f5902; font-style: italic"># start the listening thread</SPAN><SPAN style="color: #000000">listener</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">threading</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">Thread</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">target</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">thread_listener</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #000000; font-weight: bold">))</SPAN><SPAN style="color: #000000">listener</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">daemon</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">True</SPAN><SPAN style="color: #000000">listener</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">start</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">listener</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">listener</SPAN><SPAN style="color: #204a87; font-weight: bold">def</SPAN><SPAN style="color: #000000">set_cam</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;fixed&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">lower</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">startswith</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;f&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">SETTINGS_FIXED</SPAN><SPAN style="color: #204a87; font-weight: bold">elif</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">lower</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">startswith</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;s&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">SETTINGS_SENSITIVE</SPAN><SPAN style="color: #204a87; font-weight: bold">elif</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">lower</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">startswith</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;a&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">SETTINGS_AUTO</SPAN><SPAN style="color: #204a87; font-weight: bold">else</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;wrong camera mode&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #8f5902; font-style: italic"># switch on auto mode</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">awb_mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">'auto'</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">exposure_mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">'auto'</SPAN><SPAN style="color: #8f5902; font-style: italic"># settings = dict with fields: name, ss, fps, iso, g, sleep</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">framerate</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">'fps'</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">'ss'</SPAN><SPAN style="color: #000000; font-weight: bold">]:</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">shutter_speed</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">'ss'</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">iso</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">'iso'</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #8f5902; font-style: italic"># Wait for the automatic gain control to settle</SPAN><SPAN style="color: #000000">time</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">sleep</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">'sleep'</SPAN><SPAN style="color: #000000; font-weight: bold">])</SPAN><SPAN style="color: #8f5902; font-style: italic"># Now fix the values</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #204a87; font-weight: bold">not</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">'ss'</SPAN><SPAN style="color: #000000; font-weight: bold">]:</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">shutter_speed</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">exposure_speed</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">exposure_mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">'off'</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">'g'</SPAN><SPAN style="color: #000000; font-weight: bold">]:</SPAN><SPAN style="color: #000000">g</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">settings</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">'g'</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #204a87; font-weight: bold">else</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">g</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">awb_gains</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">awb_mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">'off'</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">awb_gains</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">g</SPAN><SPAN style="color: #204a87; font-weight: bold">def</SPAN><SPAN style="color: #000000">measure_slave</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">roi</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">ROI</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">channel_name</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;green&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">threshold</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">DETECTION_THRESHOLD</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">None</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">csv_out</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">None</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #8f5902; font-style: italic"># check whether channel is valid</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">channel_name</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">lower</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">startswith</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;r&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">channel</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000">channel_name</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;red&quot;</SPAN><SPAN style="color: #204a87; font-weight: bold">elif</SPAN><SPAN style="color: #000000">channel_name</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">lower</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">startswith</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;g&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">channel</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000">channel_name</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;green&quot;</SPAN><SPAN style="color: #204a87; font-weight: bold">elif</SPAN><SPAN style="color: #000000">channel_name</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">lower</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">startswith</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;b&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">channel</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">2</SPAN><SPAN style="color: #000000">channel_name</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;blue&quot;</SPAN><SPAN style="color: #204a87; font-weight: bold">else</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;wrong channel_name: '{}'&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">channel_name</SPAN><SPAN style="color: #000000; font-weight: bold">))</SPAN><SPAN style="color: #8f5902; font-style: italic"># get camera settings</SPAN><SPAN style="color: #000000">time</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">sleep</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">fps</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #204a87">float</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">framerate</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">ss</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">exposure_speed</SPAN><SPAN style="color: #000000">g</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">awb_gains</SPAN><SPAN style="color: #000000">g1</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">g</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">numerator</SPAN><SPAN style="color: #000000">g2</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">g</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">denominator</SPAN><SPAN style="color: #000000">g3</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">g</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">numerator</SPAN><SPAN style="color: #000000">g4</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">g</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">denominator</SPAN><SPAN style="color: #000000">iso</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">iso</SPAN><SPAN style="color: #000000">settings_str</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;ss{}_g{}-{}_{}-{}_iso{}_&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">ss</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">g1</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">g2</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">g3</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">g4</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">iso</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">csv_row</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #000000">fps</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">ss</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">iso</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">g1</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">g2</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">g3</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">g4</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;taking photos with settings: {}&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">settings_str</SPAN><SPAN style="color: #000000; font-weight: bold">))</SPAN><SPAN style="color: #8f5902; font-style: italic"># with picamera.PiCamera(resolution=RESOLUTION) as cam:</SPAN><SPAN style="color: #8f5902; font-style: italic"># https://picamera.readthedocs.io/en/latest/</SPAN><SPAN style="color: #8f5902; font-style: italic">#         api_array.html#module-picamera.array</SPAN><SPAN style="color: #204a87; font-weight: bold">with</SPAN><SPAN style="color: #000000">picamera</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">array</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">PiRGBArray</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">as</SPAN><SPAN style="color: #000000">output</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #8f5902; font-style: italic"># cam.zoom = REGION_OF_INTEREST</SPAN><SPAN style="color: #8f5902; font-style: italic"># cam.start_preview()</SPAN><SPAN style="color: #8f5902; font-style: italic"># take picture</SPAN><SPAN style="color: #000000">t0</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">time</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">time</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">capture</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">output</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;rgb&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">a</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">output</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">array</SPAN><SPAN style="color: #000000">t1</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">time</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">time</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;recorded for {} sec&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #204a87">round</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">t1</SPAN><SPAN style="color: #ce5c00; font-weight: bold">-</SPAN><SPAN style="color: #000000">t0</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #0000cf; font-weight: bold">2</SPAN><SPAN style="color: #000000; font-weight: bold">)))</SPAN><SPAN style="color: #000000">t_pic</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #204a87">int</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #204a87">round</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">np</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">mean</SPAN><SPAN style="color: #000000; font-weight: bold">([</SPAN><SPAN style="color: #000000">t0</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">t1</SPAN><SPAN style="color: #000000; font-weight: bold">])))</SPAN><SPAN style="color: #8f5902; font-style: italic"># re-empty output (to reuse next iteration)</SPAN><SPAN style="color: #8f5902; font-style: italic"># output.truncate(0)</SPAN><SPAN style="color: #8f5902; font-style: italic"># crop to region of interest</SPAN><SPAN style="color: #000000">roi</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">a</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #000000">ROI</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">]:</SPAN><SPAN style="color: #000000">ROI</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000">ROI</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">2</SPAN><SPAN style="color: #000000; font-weight: bold">]:</SPAN><SPAN style="color: #000000">ROI</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">3</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000; font-weight: bold">:]</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000; font-weight: bold">[]</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">append</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">np</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">median</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">roi</SPAN><SPAN style="color: #000000; font-weight: bold">[:,</SPAN><SPAN style="color: #000000; font-weight: bold">:,</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">]))</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">append</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">np</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">median</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">roi</SPAN><SPAN style="color: #000000; font-weight: bold">[:,</SPAN><SPAN style="color: #000000; font-weight: bold">:,</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">]))</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">append</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">np</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">median</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">roi</SPAN><SPAN style="color: #000000; font-weight: bold">[:,</SPAN><SPAN style="color: #000000; font-weight: bold">:,</SPAN><SPAN style="color: #0000cf; font-weight: bold">2</SPAN><SPAN style="color: #000000; font-weight: bold">]))</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">((</SPAN><SPAN style="color: #4e9a06">&quot;roi.shape={},\n&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">+</SPAN><SPAN style="color: #8f5902; font-style: italic"># &quot;sum(red)={}, sum(green)={}, sum(blue)={},\n&quot; +</SPAN><SPAN style="color: #4e9a06">&quot;med(red)={}, med(green)={}, med(blue)={}&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">roi</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">shape</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">2</SPAN><SPAN style="color: #000000; font-weight: bold">]))</SPAN><SPAN style="color: #000000">val</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #000000">channel</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;reading the {} channel...\nvalue: {}&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">channel_name</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">val</SPAN><SPAN style="color: #000000; font-weight: bold">))</SPAN><SPAN style="color: #8f5902; font-style: italic"># checking whether threshold is crossed and</SPAN><SPAN style="color: #8f5902; font-style: italic">#   signalling the master-camera</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">val</SPAN><SPAN style="color: #ce5c00; font-weight: bold">&gt;=</SPAN><SPAN style="color: #000000">threshold</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">activated</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">True</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">tx</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">on</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #204a87; font-weight: bold">else</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">activated</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">False</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">tx</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">off</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;active={} (threshold: {})&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">activated</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">threshold</SPAN><SPAN style="color: #000000; font-weight: bold">))</SPAN><SPAN style="color: #8f5902; font-style: italic"># debug mode:</SPAN><SPAN style="color: #8f5902; font-style: italic"># output images and csv if output directory exists</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">names</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #4e9a06">&quot;1-red&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;2-green&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;3-blue&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">]</SPAN><SPAN style="color: #8f5902; font-style: italic"># whole images</SPAN><SPAN style="color: #000000">fn</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;full_{}{}_0-rgb{}.png&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">settings_str</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">now_str</SPAN><SPAN style="color: #000000; font-weight: bold">())</SPAN><SPAN style="color: #000000">ffn</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">safename</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">path</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">join</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">fn</SPAN><SPAN style="color: #000000; font-weight: bold">),</SPAN><SPAN style="color: #4e9a06">&quot;file&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">plt</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">imsave</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">ffn</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">a</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">for</SPAN><SPAN style="color: #000000">i</SPAN><SPAN style="color: #204a87; font-weight: bold">in</SPAN><SPAN style="color: #204a87">range</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #0000cf; font-weight: bold">3</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">fn</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;full_{}{}_{}{}.png&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">settings_str</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">names</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #000000">i</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000">now_str</SPAN><SPAN style="color: #000000; font-weight: bold">())</SPAN><SPAN style="color: #000000">ffn</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">safename</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">path</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">join</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">fn</SPAN><SPAN style="color: #000000; font-weight: bold">),</SPAN><SPAN style="color: #4e9a06">&quot;file&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">plt</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">imsave</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">ffn</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">a</SPAN><SPAN style="color: #000000; font-weight: bold">[:,</SPAN><SPAN style="color: #000000; font-weight: bold">:,</SPAN><SPAN style="color: #000000">i</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000">vmin</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">vmax</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">255</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #8f5902; font-style: italic"># cropped to ROI</SPAN><SPAN style="color: #000000">fn</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;roi_{}{}_0-rgb{}.png&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">settings_str</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">now_str</SPAN><SPAN style="color: #000000; font-weight: bold">())</SPAN><SPAN style="color: #000000">ffn</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">safename</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">path</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">join</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">fn</SPAN><SPAN style="color: #000000; font-weight: bold">),</SPAN><SPAN style="color: #4e9a06">&quot;file&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">plt</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">imsave</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">ffn</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">roi</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">for</SPAN><SPAN style="color: #000000">i</SPAN><SPAN style="color: #204a87; font-weight: bold">in</SPAN><SPAN style="color: #204a87">range</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #0000cf; font-weight: bold">3</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">fn</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;roi_{}{}_{}{}.png&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">settings_str</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">names</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #000000">i</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000">now_str</SPAN><SPAN style="color: #000000; font-weight: bold">())</SPAN><SPAN style="color: #000000">ffn</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">safename</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">path</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">join</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">fn</SPAN><SPAN style="color: #000000; font-weight: bold">),</SPAN><SPAN style="color: #4e9a06">&quot;file&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">plt</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">imsave</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">ffn</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">roi</SPAN><SPAN style="color: #000000; font-weight: bold">[:,</SPAN><SPAN style="color: #000000; font-weight: bold">:,</SPAN><SPAN style="color: #000000">i</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000">vmin</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">vmax</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #0000cf; font-weight: bold">255</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">csv_row</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">extend</SPAN><SPAN style="color: #000000; font-weight: bold">([</SPAN><SPAN style="color: #000000">t_pic</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">from_timestamp</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">t_pic</SPAN><SPAN style="color: #000000; font-weight: bold">),</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">],</SPAN><SPAN style="color: #000000">vals</SPAN><SPAN style="color: #000000; font-weight: bold">[</SPAN><SPAN style="color: #0000cf; font-weight: bold">2</SPAN><SPAN style="color: #000000; font-weight: bold">]])</SPAN><SPAN style="color: #204a87; font-weight: bold">with</SPAN><SPAN style="color: #204a87">open</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">csv_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;at&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">as</SPAN><SPAN style="color: #000000">csvfile</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">csvwriter</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">csv</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">writer</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">csvfile</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">csvwriter</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">writerow</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">csv_row</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;wrote csv_row: {}&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">csv_row</SPAN><SPAN style="color: #000000; font-weight: bold">))</SPAN><SPAN style="color: #204a87; font-weight: bold">return</SPAN><SPAN style="color: #3465a4">None</SPAN><SPAN style="color: #204a87; font-weight: bold">def</SPAN><SPAN style="color: #000000">exit_clean</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #204a87; font-weight: bold">not</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #4e9a06">&quot;&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">close</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">active</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">False</SPAN><SPAN style="color: #3465a4">self</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">listener</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">join</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #204a87; font-weight: bold">def</SPAN><SPAN style="color: #000000">main</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">CSV_NAME</SPAN><SPAN style="color: #204a87; font-weight: bold">global</SPAN><SPAN style="color: #000000">CSV_HEADER</SPAN><SPAN style="color: #8f5902; font-style: italic"># t0 = time.time()</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">ColiCamSlave</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #8f5902; font-style: italic"># t_cam = time.time() - t0</SPAN><SPAN style="color: #8f5902; font-style: italic"># select mode (camera settings)</SPAN><SPAN style="color: #000000">current_mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #8f5902; font-style: italic"># optionally create output directory for debugging</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">debug</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #8f5902; font-style: italic"># setup output directory (and copy over the code?)</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;/home/pi/ColiCam_{}&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">now_str</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;%y%m%d&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">))</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">safename</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;dir&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #204a87; font-weight: bold">not</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">path</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">isdir</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">):</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">mkdir</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;outputting to '{}'&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">))</SPAN><SPAN style="color: #8f5902; font-style: italic"># initialize csv-log</SPAN><SPAN style="color: #000000">csv_fn</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #4e9a06">&quot;{}{}{}.csv&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">CSV_NAME</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">now_str</SPAN><SPAN style="color: #000000; font-weight: bold">())</SPAN><SPAN style="color: #000000">csv_out</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">safename</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">os</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">path</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">join</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">csv_fn</SPAN><SPAN style="color: #000000; font-weight: bold">),</SPAN><SPAN style="color: #4e9a06">'file'</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #8f5902; font-style: italic"># write header</SPAN><SPAN style="color: #204a87; font-weight: bold">with</SPAN><SPAN style="color: #204a87">open</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">csv_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #4e9a06">&quot;wt&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">as</SPAN><SPAN style="color: #000000">csvfile</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">csvwriter</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">csv</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">writer</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">csvfile</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #000000">csvwriter</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">writerow</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">CSV_HEADER</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;initialized {} with header {}&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">csv_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">CSV_HEADER</SPAN><SPAN style="color: #000000; font-weight: bold">))</SPAN><SPAN style="color: #204a87; font-weight: bold">else</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">None</SPAN><SPAN style="color: #000000">csv_out</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #3465a4">None</SPAN><SPAN style="color: #8f5902; font-style: italic"># it = 0</SPAN><SPAN style="color: #204a87; font-weight: bold">try</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">while</SPAN><SPAN style="color: #3465a4">True</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #8f5902; font-style: italic"># it += 1</SPAN><SPAN style="color: #8f5902; font-style: italic"># update mode</SPAN><SPAN style="color: #000000">new_mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #204a87; font-weight: bold">not</SPAN><SPAN style="color: #000000">current_mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #000000">new_mode</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">set_cam</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">new_mode</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #8f5902; font-style: italic"># cam.set_cam(mode=args.mode)</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;measuring in {} mode (default):&quot;</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">format</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">mode</SPAN><SPAN style="color: #000000; font-weight: bold">))</SPAN><SPAN style="color: #8f5902; font-style: italic"># measure with both cams</SPAN><SPAN style="color: #000000">val</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">measure</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">dir_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">csv_out</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">csv_out</SPAN><SPAN style="color: #000000; font-weight: bold">,</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #ce5c00; font-weight: bold">=</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">postfix</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">val</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #ce5c00; font-weight: bold">-</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;wall on the left\n&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">elif</SPAN><SPAN style="color: #000000">val</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #0000cf; font-weight: bold">0</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;no wall detected\n&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">elif</SPAN><SPAN style="color: #000000">val</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #0000cf; font-weight: bold">1</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;wall on the right\n&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">except</SPAN><SPAN style="color: #cc0000; font-weight: bold">KeyboardInterrupt</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;manually interrupted program&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">finally</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">cam</SPAN><SPAN style="color: #ce5c00; font-weight: bold">.</SPAN><SPAN style="color: #000000">exit_clean</SPAN><SPAN style="color: #000000; font-weight: bold">()</SPAN><SPAN style="color: #204a87; font-weight: bold">print</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #4e9a06">&quot;camera closed, done!&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN><SPAN style="color: #204a87; font-weight: bold">if</SPAN><SPAN style="color: #000000">__name__</SPAN><SPAN style="color: #ce5c00; font-weight: bold">==</SPAN><SPAN style="color: #4e9a06">&quot;__main__&quot;</SPAN><SPAN style="color: #000000; font-weight: bold">:</SPAN><SPAN style="color: #000000">main</SPAN><SPAN style="color: #000000; font-weight: bold">(</SPAN><SPAN style="color: #000000">args</SPAN><SPAN style="color: #000000; font-weight: bold">)</SPAN></PRE></TD></TR></TBODY></TABLE></DIV></DIV></DIV></DIV></DIV></DIV></DIV></DIV></BODY></HTML>