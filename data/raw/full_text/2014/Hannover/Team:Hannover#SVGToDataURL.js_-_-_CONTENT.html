<HTML xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
<style type="text/css">
A:before { content:' '; } 
A:after { content:' '; } 
SPAN:before { content:' '; } 
SPAN:after { content:' '; } 
</style>
<BODY class="mediawiki  ltr ns-0 ns-subject page-Team_Hannover_SVGToDataURL_js"><DIV id="globalWrapper"><DIV id="top-section"><DIV id="p-logo"><A href="/Main_Page" title="Main Page">&quot;
	    </A></DIV><DIV id="menubar" class="left-menu noprint"><UL><LI class="selected"><A href="/Team:Hannover/SVGToDataURL.js">Page               </A></LI><LI class="new"><A href="/wiki/index.php?title=Talk:Team:Hannover/SVGToDataURL.js&amp;action=edit&amp;redlink=1">Discussion               </A></LI><LI><A href="/wiki/index.php?title=Team:Hannover/SVGToDataURL.js&amp;action=edit">View source               </A></LI><LI><A href="/wiki/index.php?title=Team:Hannover/SVGToDataURL.js&amp;action=history">History               </A></LI><LI style="color:white;cursor:default">teams</LI></UL></DIV><DIV class="right-menu noprint" id="menubar"><UL><LI id="pt-login"><A href="/wiki/index.php?title=Special:UserLogin&amp;returnto=Team:Hannover/SVGToDataURL.js" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</A></LI></UL></DIV><DIV id="search-controls" class="noprint"><FORM action="/Special:Search" id="searchform"> </FORM></DIV></DIV><DIV id="content"><H1 class="firstHeading">Team:Hannover/SVGToDataURL.js</H1><DIV id="bodyContent"><H3 id="siteSub" class="noprint">From 2014.igem.org</H3><P>/**
	The missing SVG.toDataURL library for your SVG elements.
</P><P>	Usage: SVGElement.toDataURL( type, { options } )
</P><P>	Returns: the data URL, except when using native PNG renderer (needs callback).
</P><P>	type	MIME type of the exported data.
			Default: image/svg+xml.
			Must support: image/png.
			Additional: image/jpeg.
</P><P>	options is a map of options: {
		callback: function(dataURL)
			Callback function which is called when the data URL is ready.
			This is only necessary when using native PNG renderer.
			Default: undefined.
</P><P>		[the rest of the options only apply when type=&quot;image/png&quot; or type=&quot;image/jpeg&quot;]
</P><P>		renderer: &quot;native&quot;|&quot;canvg&quot;
			PNG renderer to use. Native renderer¹ might cause a security exception.
			Default: canvg if available, otherwise native.
</P><P>		keepNonSafe: true|false
			Export non-safe (image and foreignObject) elements.
			This will set the Canvas origin-clean property to false, if this data is transferred to Canvas.
			Default: false, to keep origin-clean true.
			NOTE: not currently supported and is just ignored.
</P><P>		keepOutsideViewport: true|false
			Export all drawn content, even if not visible.
			Default: false, export only visible viewport, similar to Canvas toDataURL().
			NOTE: only supported with canvg renderer.
	}
</P><P>	See original paper¹ for more info on SVG to Canvas exporting.
</P><P>	¹ <A href="http://svgopen.org/2010/papers/62-From_SVG_to_Canvas_and_Back/#svg_to_canvas" class="external free" rel="nofollow">http://svgopen.org/2010/papers/62-From_SVG_to_Canvas_and_Back/#svg_to_canvas</A></P><UL><LI>/
</LI></UL><P>SVGElement.prototype.toDataURL = function(type, options) {
	var _svg = this;
</P><P>	function debug(s) {
		console.log(&quot;SVG.toDataURL:&quot;, s);
	}
</P><P>	function exportSVG() {
		var svg_xml = XMLSerialize(_svg);
		var svg_dataurl = base64dataURLencode(svg_xml);
		debug(type + &quot; length: &quot; + svg_dataurl.length);
</P><P>		// NOTE double data carrier
		if (options.callback) options.callback(svg_dataurl);
		return svg_dataurl;
	}
</P><P>	function XMLSerialize(svg) {
</P><P>		// quick-n-serialize an SVG dom, needed for IE9 where there's no XMLSerializer nor SVG.xml
		// s: SVG dom, which is the &lt;svg&gt; elemennt
		function XMLSerializerForIE(s) {
			var out = &quot;&quot;;
</P><P>			out += &quot;&lt;&quot; + s.nodeName;
			for (var n = 0; n &lt; s.attributes.length; n++) {
				out += &quot; &quot; + s.attributes[n].name + &quot;=&quot; + &quot;'&quot; + s.attributes[n].value + &quot;'&quot;;
			}
</P><P>			if (s.hasChildNodes()) {
				out += &quot;&gt;\n&quot;;
</P><P>				for (var n = 0; n &lt; s.childNodes.length; n++) {
					out += XMLSerializerForIE(s.childNodes[n]);
				}
</P><P>				out += &quot;&lt;/&quot; + s.nodeName + &quot;&gt;&quot; + &quot;\n&quot;;
</P><P>			} else out += &quot; /&gt;\n&quot;;
</P><P>			return out;
		}
</P><P>		
		if (window.XMLSerializer) {
			debug(&quot;using standard XMLSerializer.serializeToString&quot;)
			return (new XMLSerializer()).serializeToString(svg);
		} else {
			debug(&quot;using custom XMLSerializerForIE&quot;)
			return XMLSerializerForIE(svg);
		}
</P><P>	}
</P><P>	function base64dataURLencode(s) {
		var b64 = &quot;data:image/svg+xml;base64,&quot;;
</P><P>		// <A href="https://developer.mozilla.org/en/DOM/window.btoa" class="external free" rel="nofollow">https://developer.mozilla.org/en/DOM/window.btoa</A>
		if (window.btoa) {
			debug(&quot;using window.btoa for base64 encoding&quot;);
			b64 += btoa(s);
		} else {
			debug(&quot;using custom base64 encoder&quot;);
			b64 += Base64.encode(s);
		}
</P><P>		return b64;
	}
</P><P>	function exportImage(type) {
		var canvas = document.createElement(&quot;canvas&quot;);
		var ctx = canvas.getContext('2d');
</P><P>		// TODO: if (options.keepOutsideViewport), do some translation magic?
</P><P>		var svg_img = new Image();
		var svg_xml = XMLSerialize(_svg);
		svg_img.src = base64dataURLencode(svg_xml);
</P><P>		svg_img.onload = function() {
			debug(&quot;exported image size: &quot; + [svg_img.width, svg_img.height])
			canvas.width = svg_img.width;
			canvas.height = svg_img.height;
			ctx.drawImage(svg_img, 0, 0);
</P><P>			// SECURITY_ERR WILL HAPPEN NOW
			var png_dataurl = canvas.toDataURL(type);
			debug(type + &quot; length: &quot; + png_dataurl.length);
</P><P>			if (options.callback) options.callback( png_dataurl );
			else debug(&quot;WARNING: no callback set, so nothing happens.&quot;);
		}
</P><P>		svg_img.onerror = function() {
			console.log(
				&quot;Can't export! Maybe your browser doesn't support &quot; +
				&quot;SVG in img element or SVG input for Canvas drawImage?\n&quot; +
				&quot;<A href="http://en.wikipedia.org/wiki/SVG#Native_support" class="external free" rel="nofollow">http://en.wikipedia.org/wiki/SVG#Native_support</A>&quot;
			);
		}
</P><P>		// NOTE: will not return anything
	}
</P><P>	function exportImageCanvg(type) {
		var canvas = document.createElement(&quot;canvas&quot;);
		var ctx = canvas.getContext('2d');
		var svg_xml = XMLSerialize(_svg);
</P><P>		// NOTE: canvg gets the SVG element dimensions incorrectly if not specified as attributes
		//debug(&quot;detected svg dimensions &quot; + [_svg.clientWidth, _svg.clientHeight])
		//debug(&quot;canvas dimensions &quot; + [canvas.width, canvas.height])
</P><P>		var keepBB = options.keepOutsideViewport;
		if (keepBB) var bb = _svg.getBBox();
</P><P>		// NOTE: this canvg call is synchronous and blocks
		canvg(canvas, svg_xml, { 
			ignoreMouse: true, ignoreAnimation: true,
			offsetX: keepBB ? -bb.x : undefined, 
			offsetY: keepBB ? -bb.y : undefined,
			scaleWidth: keepBB ? bb.width+bb.x : undefined,
			scaleHeight: keepBB ? bb.height+bb.y : undefined,
			renderCallback: function() {
				debug(&quot;exported image dimensions &quot; + [canvas.width, canvas.height]);
				var png_dataurl = canvas.toDataURL(type);
				debug(type + &quot; length: &quot; + png_dataurl.length);
</P><P>				if (options.callback) options.callback( png_dataurl );
			}
		});
</P><P>		// NOTE: return in addition to callback
		return canvas.toDataURL(type);
	}
</P><P>	// BEGIN MAIN
</P><P>	if (!type) type = &quot;image/svg+xml&quot;;
	if (!options) options = {};
</P><P>	if (options.keepNonSafe) debug(&quot;NOTE: keepNonSafe is NOT supported and will be ignored!&quot;);
	if (options.keepOutsideViewport) debug(&quot;NOTE: keepOutsideViewport is only supported with canvg exporter.&quot;);
</P><P>	switch (type) {
		case &quot;image/svg+xml&quot;:
			return exportSVG();
			break;
</P><P>		case &quot;image/png&quot;:
		case &quot;image/jpeg&quot;:
</P><P>			if (!options.renderer) {
				if (window.canvg) options.renderer = &quot;canvg&quot;;
				else options.renderer=&quot;native&quot;;
			}
</P><P>			switch (options.renderer) {
				case &quot;canvg&quot;:
					debug(&quot;using canvg renderer for png export&quot;);
					return exportImageCanvg(type);
					break;
</P><P>				case &quot;native&quot;:
					debug(&quot;using native renderer for png export. THIS MIGHT FAIL.&quot;);
					return exportImage(type);
					break;
</P><P>				default:
					debug(&quot;unknown png renderer given, doing noting (&quot; + options.renderer + &quot;)&quot;);
			}
</P><P>			break;
</P><P>		default:
			debug(&quot;Sorry! Exporting as '&quot; + type + &quot;' is not supported!&quot;)
	}
}
</P><DIV class="printfooter">
Retrieved from &quot;<A href="http://2014.igem.org/Team:Hannover/SVGToDataURL.js">http://2014.igem.org/Team:Hannover/SVGToDataURL.js</A>&quot;</DIV></DIV></DIV><DIV id="footer-box" class="noprint"><DIV id="footer"><UL id="f-list"><LI id="t-recentchanges"><A href="/Special:RecentChanges" title="Recent changes">Recent changes</A></LI><LI id="t-whatlinkshere"><A href="/Special:WhatLinksHere/Team:Hannover/SVGToDataURL.js" title="List of all wiki pages that link here [j]" accesskey="j">What links here</A></LI><LI id="t-recentchangeslinked"><A href="/Special:RecentChangesLinked/Team:Hannover/SVGToDataURL.js" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</A></LI><LI id="t-specialpages"><A href="/Special:SpecialPages" title="List of all special pages [q]" accesskey="q">Special pages</A></LI><LI><A href="/Special:Preferences">My preferences</A></LI></UL></DIV><DIV id="footer"><UL id="f-list"><LI id="t-print"><A href="/wiki/index.php?title=Team:Hannover/SVGToDataURL.js&amp;printable=yes" title="Printable version of this page [p]" accesskey="p">Printable version</A></LI><LI id="t-permalink"><A href="/wiki/index.php?title=Team:Hannover/SVGToDataURL.js&amp;oldid=181207" title="Permanent link to this revision of the page">Permanent link</A></LI><LI id="privacy"><A href="/2014.igem.org:Privacy_policy" title="2014.igem.org:Privacy policy">Privacy policy</A></LI><LI id="disclaimer"><A href="/2014.igem.org:General_disclaimer" title="2014.igem.org:General disclaimer">Disclaimers</A></LI></UL></DIV></DIV></DIV></BODY></HTML>